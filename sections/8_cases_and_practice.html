<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7. Кейсы и Практика - Семинар НКО</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/animations.css">
    
    <style>
        body { 
            padding-top: 70px; 
            overflow-x: hidden; 
            background-color: #f8f9fa; /* Light grey background for the page */
        }
        .page-header-section {
            background: linear-gradient(135deg, #6f42c1 0%, #4a148c 100%); /* Purple/Violet gradient */
            color: white;
            padding: 4rem 1.5rem;
            margin-bottom: 2.5rem;
            border-radius: .3rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .page-header-section img.header-icon { 
            width: 80px; height: 80px; margin-bottom: 1rem; filter: brightness(0) invert(1);
            animation: pulseIcon 2s infinite ease-in-out;
        }
        @keyframes pulseIcon {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .content-section { 
            margin-bottom: 3rem; 
            opacity: 0; 
            transform: translateY(40px);
        }
        .content-section h3, .content-section h4 { 
            margin-bottom: 1.5rem; display: flex; align-items: center; 
            font-weight: 600; color: #343a40;
        }
        .content-section h3 img.section-icon, .content-section h4 img.section-icon { 
            width: 32px; height: 32px; margin-right: 0.8rem; opacity: 0.85;
        }

        /* Case Study Card Styles */
        .case-study-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--case-color, var(--bs-primary)); /* Default, will be overridden by JS */
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.07);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0; /* For GSAP */
            transform: translateY(30px); /* For GSAP */
        }
        .case-study-card:hover {
            transform: translateY(-5px) scale(1.015);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        .case-study-card h5 { 
            color: var(--case-color, var(--bs-primary)); 
            margin-bottom: 0.75rem; 
            font-weight: 600;
        }
        .case-study-card .tags .badge { 
            margin-right: 5px; 
            font-size: 0.75em; 
            padding: 0.3em 0.6em;
            margin-bottom: 0.5rem;
        }
        .case-study-card p { 
            font-size: 0.95rem; 
            line-height: 1.6; 
            color: #555;
        }
        .case-study-card strong { color: #333; }
        .case-study-card ul {
            padding-left: 20px;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .case-study-card ul li {
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        .case-study-card a.case-link { 
            font-weight: 500; 
            font-size: 0.9rem;
            color: var(--case-color, var(--bs-primary));
            text-decoration: none;
            border-bottom: 1px dashed var(--case-color, var(--bs-primary));
            transition: color 0.2s, border-bottom-color 0.2s;
        }
        .case-study-card a.case-link:hover {
            color: var(--bs-link-hover-color);
            border-bottom-color: var(--bs-link-hover-color);
        }
        .case-study-card .disclaimer {
            font-size: 0.8rem;
            color: #777;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px dashed #eee;
        }

        /* NPO Profile Matcher Styles - UPDATED for Tiles */
        #npoMatcherSection {
            background-color: #f0eafc; /* Lighter purple background */
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(111, 66, 193, 0.1); /* Purple shadow */
        }
        #npoMatcherSection .filter-group-title {
            font-weight: 600; /* Bolder title */
            color: #4a148c; /* Darker purple for title */
            margin-bottom: 1rem; /* Increased bottom margin */
            font-size: 1.15rem;
            text-align: left; /* Align title to the left */
        }
        #npoMatcherSection .tiles-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* Increased spacing between tiles */
            margin-bottom: 2rem; /* Spacing between filter groups */
            justify-content: flex-start; /* Align tiles to the start */
        }

        #npoMatcherSection .filter-tile {
            display: inline-block;
            padding: 0.6rem 1.1rem; /* Adjusted padding for better feel */
            font-size: 0.9rem;
            font-weight: 500;
            color: #6f42c1; /* Main purple for text */
            background-color: #fff;
            border: 1px solid #d1c4e9; /* Lighter purple border */
            border-radius: 25px; /* Pill shape */
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            opacity: 0; /* Initial for GSAP */
            transform: scale(0.85) translateY(15px); /* Initial for GSAP */
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }

        #npoMatcherSection .filter-tile:hover {
            background-color: #f3e5f5; /* Very light purple for hover */
            border-color: #9c27b0; /* Slightly darker purple border on hover */
            color: #7b1fa2;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        #npoMatcherSection .filter-tile.active {
            background-color: #6f42c1; /* Main purple from header */
            color: #fff;
            border-color: #5e35b1; /* Darker border for active */
            transform: scale(1.03) translateY(0); /* Slight pop on active, no Y shift */
            box-shadow: 0 5px 12px rgba(111, 66, 193, 0.35);
        }

        #npoMatcherSection .btn-match {
            background: linear-gradient(135deg, #6f42c1, #8e24aa); /* Refined gradient */
            border: none;
            padding: 0.7rem 2rem; /* Adjusted padding for button */
            font-weight: 500;
        }
        #npoMatcherSection .btn-match:hover {
            background: linear-gradient(135deg, #5e35b1, #7b1fa2);
        }
        #matchedCasesContainer { margin-top: 2rem; }
        .no-cases-found {
            text-align: center;
            padding: 1.5rem;
            background-color: #fff3cd;
            color: #664d03;
            border: 1px solid #ffeeba;
            border-radius: 8px;
        }
        
        /* AI Advisor Block */
        .ai-advisor-block {
            background-color: #fdf9ff; /* Very light purple */
            border: 1px solid #e6d9f2;
            padding: 2.5rem;
            border-radius: 12px;
            margin-top: 2.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.07);
        }
        .ai-advisor-block h4 { color: #6f42c1; }
        .ai-advisor-block textarea { min-height: 100px; }
        .ai-advisor-block .btn-ai {
            background: linear-gradient(135deg, #8a3ab9, #bc2a8d); /* Instagram-like purple gradient */
            border: none;
        }
        #aiCaseAdviceContainer { display: none; margin-top: 1.5rem; }
        #aiCaseAdviceResult { white-space: pre-wrap; background-color: #fff; padding: 1rem; border-radius: 8px; border: 1px solid #eee; }

        /* Filter Checkbox Animation */
        .filter-checkbox-group .form-check {
            opacity: 0;
            transform: translateX(-20px);
        }

        /* Navigation Bar Styles */
        .section-nav-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.97);
            box-shadow: 0 2px 8px rgba(32, 201, 151, 0.07);
            padding: 0.5rem 0;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }
        .section-nav-btn {
            flex: 1;
            text-align: center;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s, color 0.3s;
        }
        .section-nav-btn:hover {
            background-color: rgba(111, 66, 193, 0.1);
        }
        .section-nav-btn.active {
            background-color: #6f42c1;
            color: white;
        }
    </style>
</head>

<body>
    <!-- НАВИГАЦИЯ ПО РАЗДЕЛАМ -->
    <nav class="section-nav-bar">
      <a href="0_introduction.html" class="btn btn-outline-success section-nav-btn">Введение</a>
      <a href="1_community_building.html" class="btn btn-outline-success section-nav-btn">1. Сообщество</a>
      <a href="2_internal_communications.html" class="btn btn-outline-success section-nav-btn">2. Коммуникации</a>
      <a href="3_infrastructure.html" class="btn btn-outline-success section-nav-btn">3. Инфраструктура</a>
      <a href="4_legal_and_security.html" class="btn btn-outline-success section-nav-btn">4. Право и безопасность</a>
      <a href="5_effectiveness_and_development.html" class="btn btn-outline-success section-nav-btn">5. Эффективность</a>
      <a href="6_crisis_management.html" class="btn btn-outline-success section-nav-btn">6. Кризисы</a>
      <a href="7_fundraising.html" class="btn btn-outline-success section-nav-btn">7. Фандрайзинг</a>
      <a href="8_cases_and_practice.html" class="btn btn-success section-nav-btn">8. Кейсы</a>
      <a href="useful_resources.html" class="btn btn-outline-secondary section-nav-btn">Ресурсы</a>
    </nav>
    <!-- /НАВИГАЦИЯ ПО РАЗДЕЛАМ -->

    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
            <div class="container">
                <a class="navbar-brand fw-bold d-flex align-items-center" href="../index.html">
                    <img src="../assets/images/logo.svg" alt="Лого НКО"> 
                    Семинар НКО
                </a>
                <button class="navbar-custom-toggler ms-auto" aria-label="Открыть меню" id="customMenuToggler" aria-expanded="false">
                    <svg viewBox="0 0 100 80" width="30" height="30" id="actualBurgerIcon" fill="currentColor">
                        <rect class="line line1" x="0" y="10" width="100" height="10" rx="5"></rect>
                        <rect class="line line2" x="0" y="35" width="100" height="10" rx="5"></rect>
                        <rect class="line line3" x="0" y="60" width="100" height="10" rx="5"></rect>
                    </svg>
                </button>
            </div>
        </nav>
    </header>

    <div class="fullscreen-menu" id="fullscreenMenu">
        <button class="close-menu-btn" id="closeFullscreenMenu" aria-label="Закрыть меню">×</button>
        <ul class="navbar-nav-fullscreen">
            <li class="nav-item fs-menu-item">
                <a class="nav-link" href="../index.html">Главная</a>
            </li>
            <li class="nav-item fs-menu-item custom-dropdown">
                <a class="nav-link dropdown-toggle-custom active" aria-current="page" href="#" id="sectionsDropdownCustomFs" role="button" aria-expanded="false">
                    Разделы
                </a>
                <ul class="dropdown-menu-custom">
                    <li><a class="dropdown-item" href="0_introduction.html">0. Введение</a></li>
                    <li><a class="dropdown-item" href="1_community_building.html">1. Сообщество</a></li>
                    <li><a class="dropdown-item" href="2_internal_communications.html">2. Коммуникации</a></li>
                    <li><a class="dropdown-item" href="3_infrastructure.html">3. Инфраструктура</a></li>
                    <li><a class="dropdown-item" href="4_legal_and_security.html">4. Безопасность</a></li>
                    <li><a class="dropdown-item" href="5_effectiveness_and_development.html">5. Эффективность</a></li>
                    <li><a class="dropdown-item" href="6_crisis_management.html">6. Антикризис</a></li>
                    <li><a class="dropdown-item" href="7_fundraising.html">7. Фандрайзинг</a></li>
                    <li><a class="dropdown-item active" href="8_cases_and_practice.html">8. Практика и кейсы</a></li>
                </ul>
            </li>
            <li class="nav-item fs-menu-item">
                <a class="nav-link" href="useful_resources.html">Полезные ресурсы</a>
            </li>
        </ul>
    </div>

    <main>
        <div class="page-header-section">
            <img src="../assets/icons/cases.svg" alt="Кейсы и Практика" class="header-icon">
            <h1 class="display-5 fw-bold">Раздел 7: Кейсы и Практика</h1>
            <p class="lead">Изучаем реальный опыт НКО, находим лучшие практики и применяем их в своей работе.</p>
        </div>

        <div class="container py-4">
            <!-- 7.1. Разбор Кейсов НКО -->
            <section class="content-section" id="s7-1">
                <h3>
                    <img src="../assets/icons/community.svg" alt="Разбор кейсов" class="section-icon">
                    7.1. Разбор кейсов: Истории успеха и вызовов
                </h3>
                <p>Анализ деятельности существующих НКО – ценный источник знаний. Мы рассмотрим несколько примеров организаций, работающих в различных условиях и с разными фокусами, уделяя внимание их подходам к построению сообщества, обеспечению устойчивости и преодолению трудностей.</p>
                <div id="caseStudiesContainer" class="row mt-4">
                    <!-- Карточки кейсов будут добавлены JS -->
                </div>
            </section>

            <!-- 7.2. Интерактив: Подбор релевантных кейсов -->
            <section class="content-section" id="npoMatcherSection">
                <h4 class="text-center">
                    <img src="../assets/icons/interactivity.svg" alt="Подбор кейсов" class="section-icon me-2">
                    Интерактив: Подбор релевантных кейсов
                </h4>
                <p class="text-center text-muted mb-4">Кликните на плитки, чтобы выбрать интересующие вас направления и условия работы, затем нажмите "Подобрать кейсы".</p>
                
                <div class="mb-4"> 
                    <h5 class="filter-group-title">Области деятельности/интереса:</h5>
                    <div class="tiles-container" id="interestTilesContainer">
                        <!-- Плитки для областей интереса будут добавлены JS -->
                    </div>
                </div>
                
                <div class="mb-4"> 
                    <h5 class="filter-group-title">Условия работы/контекст:</h5>
                    <div class="tiles-container" id="conditionTilesContainer">
                        <!-- Плитки для условий работы будут добавлены JS -->
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary btn-lg btn-match" id="matchNPOsBtn">Подобрать кейсы</button>
                </div>
                <div id="matchedCasesContainer" class="row mt-4">
                    <!-- Отфильтрованные кейсы -->
                </div>
            </section>

            <!-- 7.3. AI Советник -->
            <section class="content-section ai-advisor-block" id="s7-3">
                <h4>
                    <img src="../assets/icons/support.svg" alt="AI Советник" class="section-icon me-2">
                    AI Советник: Какие кейсы мне изучить?
                </h4>
                <p>Опишите кратко фокус вашей (или планируемой) НКО и основные вызовы, с которыми вы сталкиваетесь или ожидаете столкнуться. ИИ предложит, опыт каких организаций из представленных может быть для вас наиболее полезен.</p>
                <div class="mb-3">
                    <label for="npoDescriptionForAI" class="form-label">Описание вашей НКО и вызовов:</label>
                    <textarea class="form-control" id="npoDescriptionForAI" rows="4" placeholder="Например: Мы небольшая инициативная группа, занимаемся правовым просвещением молодежи в регионе. Основные вызовы - нехватка ресурсов и сложности с привлечением волонтеров в условиях ограничений..."></textarea>
                </div>
                <button type="button" class="btn btn-lg btn-ai text-white" id="getAICaseAdviceBtn">Получить совет от ИИ</button>
                <div id="aiCaseAdviceContainer" class="mt-3">
                    <h5 class="text-primary">Комментарий от ИИ-помощника:</h5>
                    <div id="aiCaseAdviceResult" class="p-3 border rounded bg-light-subtle text-muted">
                        <em>Заполните описание и нажмите кнопку...</em>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <footer class="py-4 bg-dark text-white-50 mt-5">
        <div class="container text-center">
            <small>Материалы семинара © 2024.</small> <br>
            <small><em>Информация на сайте носит ознакомительный характер и не является юридической консультацией. Для принятия решений всегда обращайтесь к квалифицированным специалистам.</em></small>
            <div class="mt-4">
                <button class="btn btn-success" id="exportCasesResultsBtn">Выгрузить результаты раздела</button>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script>
    <script src="../assets/fonts/Qanelas-Regular.js"></script> <!-- Для PDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        gsap.registerPlugin(ScrollTrigger);

        // --- Полноэкранное меню (стандартный код) ---
        const customMenuToggler = document.getElementById('customMenuToggler');
        const fullscreenMenu = document.getElementById('fullscreenMenu');
        const closeFullscreenMenuBtn = document.getElementById('closeFullscreenMenu');
        if (customMenuToggler && fullscreenMenu) {
            const fsNav = fullscreenMenu.querySelector('.navbar-nav-fullscreen');
            const fsMenuItems = fsNav ? gsap.utils.toArray(fsNav.querySelectorAll('.fs-menu-item > a, .fs-menu-item > .dropdown-toggle-custom')) : [];
            const fsSubMenuItemsContainer = fsNav ? fsNav.querySelector('.fs-menu-item.custom-dropdown .dropdown-menu-custom') : null;
            const actualBurgerIcon = customMenuToggler.querySelector('svg');
            const burgerLine1 = actualBurgerIcon?.querySelector('.line1');
            const burgerLine2 = actualBurgerIcon?.querySelector('.line2');
            const burgerLine3 = actualBurgerIcon?.querySelector('.line3');
            let burgerTimeline = gsap.timeline({ paused: true, reversed: true });
            if (burgerLine1 && burgerLine2 && burgerLine3) {
                const line1YInitial = parseFloat(burgerLine1.getAttribute('y'));
                const line2YInitial = parseFloat(burgerLine2.getAttribute('y'));
                if (!isNaN(line1YInitial) && !isNaN(line2YInitial)) {
                    burgerTimeline.to(burgerLine1,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross").to(burgerLine3,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross").to(burgerLine2,{duration:0.2,scaleX:0,transformOrigin:"50% 50%",ease:"power2.in"},"cross").to(burgerLine1,{duration:0.25,rotation:45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd").to(burgerLine3,{duration:0.25,rotation:-45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd");
                } else { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
            } else if (actualBurgerIcon) { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"});}
            let fsMenuIsOpen = false;
            gsap.set(fullscreenMenu, { display: 'none', autoAlpha: 0 }); 
            if (fsMenuItems.length > 0) gsap.set(fsMenuItems, { autoAlpha: 0, y: 20 });
            if (fsSubMenuItemsContainer) gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
            const openFullscreenMenu = () => { if (fsMenuIsOpen) return; fsMenuIsOpen = true; fullscreenMenu.style.display = 'flex'; burgerTimeline.play(); customMenuToggler.classList.add('open'); customMenuToggler.setAttribute('aria-expanded', 'true'); const tlOpen = gsap.timeline().to(fullscreenMenu, { autoAlpha: 1, duration: 0.35, ease: 'power1.out' }); if (fsMenuItems.length > 0) tlOpen.to(fsMenuItems, { autoAlpha: 1, y: 0, duration: 0.3, stagger: 0.06, ease: 'power1.out' }, "-=0.2"); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if (sectionsDropdownCustomFs?.classList.contains('active') && fsSubMenuItemsContainer && (sectionsDropdownCustomFs.getAttribute('aria-expanded') === 'true' || fsSubMenuItemsContainer.style.height === 'auto')) { tlOpen.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration: 0.2, stagger: 0.04, ease: 'power1.out'}, "-=0.1");}};
            const closeFullscreenMenu = () => {if (!fsMenuIsOpen) return; fsMenuIsOpen = false; burgerTimeline.reverse(); customMenuToggler.classList.remove('open'); customMenuToggler.setAttribute('aria-expanded', 'false'); const tlClose = gsap.timeline({onComplete: () => {fullscreenMenu.style.display = 'none'; if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) {gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10}); gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0}); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if(sectionsDropdownCustomFs) sectionsDropdownCustomFs.setAttribute('aria-expanded', 'false');}}}); if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { tlClose.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10, duration:0.15, stagger: {each:0.03, from:"end"}, ease:'power1.in'});} if (fsMenuItems.length > 0) tlClose.to(fsMenuItems, { autoAlpha: 0, y: 15, duration: 0.2, stagger: { each: 0.04, from: "end" }, ease: 'power1.in' }, fsSubMenuItemsContainer ? "-=0.1" : 0); tlClose.to(fullscreenMenu, { autoAlpha: 0, duration: 0.25, ease: 'power1.in'}, fsMenuItems.length > 0 ? "-=0.1" : 0); };
            customMenuToggler.addEventListener('click', () => { fsMenuIsOpen ? closeFullscreenMenu() : openFullscreenMenu(); });
            if (closeFullscreenMenuBtn) closeFullscreenMenuBtn.addEventListener('click', closeFullscreenMenu);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && fsMenuIsOpen) closeFullscreenMenu(); });
            const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs');
            if (sectionsDropdownCustomFs && fsSubMenuItemsContainer) {gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop:0, marginBottom:0 }); gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10}); let subMenuFsIsOpen = false; sectionsDropdownCustomFs.addEventListener('click', (e) => {e.preventDefault(); subMenuFsIsOpen = !subMenuFsIsOpen; sectionsDropdownCustomFs.setAttribute('aria-expanded', subMenuFsIsOpen.toString()); if (subMenuFsIsOpen) {gsap.timeline().to(fsSubMenuItemsContainer, { height: 'auto', autoAlpha: 1, marginTop: '0.5rem', marginBottom: '0.5rem', duration: 0.3, ease: 'power1.out' }).to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration:0.25, stagger:0.05, ease:'power1.out'}, "-=0.2");} else {gsap.timeline().to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.2, stagger:{each:0.04, from:"end"}, ease:'power1.in'}).to(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0, duration: 0.3, ease: 'power1.in' }, "-=0.1");}}); const fsSubMenuLinks = fsSubMenuItemsContainer ? gsap.utils.toArray(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item')) : []; fsSubMenuLinks.forEach(link => {link.addEventListener('mouseenter', () => gsap.to(link, { color: '#0d6efd', x: 3, duration: 0.2 })); link.addEventListener('mouseleave', () => gsap.to(link, { color: (link.classList.contains('active') ? '#0d6efd' : '#495057'), x: 0, duration: 0.2 }));});}
            const activeFsDropdownItem = fullscreenMenu.querySelector('.dropdown-menu-custom a.dropdown-item.active');
            if (activeFsDropdownItem) { activeFsDropdownItem.style.color = '#0d6efd'; activeFsDropdownItem.style.fontWeight = '500';}
        }


        // --- Анимации появления секций ---
        gsap.from(".page-header-section h1, .page-header-section p.lead", {
            duration: 0.8, y: -30, opacity: 0, ease: "power2.out", stagger: 0.2, delay: 0.2
        });
        gsap.utils.toArray('.content-section').forEach((section, i) => {
            gsap.to(section, {
                opacity: 1, y: 0, duration: 0.7, delay: 0.1 + i * 0.1,
                scrollTrigger: { trigger: section, start: 'top 85%', once: true }
            });
        });

        // --- Данные для кейсов (РАСШИРЕННЫЙ СПИСОК) ---
        const caseData = [
            {
                id: "ovdinfo",
                title: "ОВД-Инфо*",
                color: "#007bff", // Blue
                tags: ["Правовая помощь", "Мониторинг", "Медиа", "Волонтерство", "Давление/Блокировки", "В России"],
                description: "Независимый правозащитный медиапроект, документирующий политические преследования и координирующий юридическую помощь задержанным на публичных акциях в России.",
                community_aspects: [
                    "Создание доступных каналов помощи (горячая линия, Telegram-боты).",
                    "Развитие крупной волонтерской сети для мониторинга и поддержки.",
                    "Активная информационная работа и создание востребованного медиа-контента.",
                    "Опора на краудфандинг и формирование сообщества доноров.",
                    "Образовательные проекты для повышения правовой грамотности."
                ],
                link: "https://ovd.info",
                disclaimer: "* Проект признан Минюстом РФ «иностранным агентом» и «нежелательной организацией», сайт заблокирован в РФ."
            },
            {
                id: "kpp",
                title: "Команда против пыток*",
                color: "#dc3545", // Red
                tags: ["Борьба с пытками", "Юридическая помощь", "Общественное расследование", "Релокация части команды", "В России"],
                description: "Правозащитная организация, занимающаяся расследованием заявлений о пытках и оказанием помощи пострадавшим.",
                community_aspects: [
                    "Публичность и открытость в освещении дел, формирование общественного запроса.",
                    "Привлечение сети сотрудничающих юристов и независимых экспертов.",
                    "Опора на частные пожертвования и краудфандинг для финансовой устойчивости.",
                    "Поддержка пострадавших и их семей, формирование сообщества вокруг них.",
                    "Адаптивность: продолжение работы как незарегистрированное объединение после ликвидации юрлица."
                ],
                link: "https://pytkam.net/",
                disclaimer: "* Ранее «Комитет против пыток». Организация была внесена в реестр НКО-иноагентов и ликвидирована. Продолжает работу как незарегистрированное объединение."
            },
            {
                id: "sakharov_center",
                title: "Проекты Сахаровского центра*",
                color: "#ffc107", // Yellow-Orange
                tags: ["Просвещение", "Права человека", "Культура", "История", "Волонтерство", "Ликвидирована в РФ", "В изгнании/Продолжение деятельности"],
                description: "Ликвидированный в РФ культурный и общественный центр, занимавшийся сохранением наследия А.Д. Сахарова, правозащитной и просветительской деятельностью. Проекты (Школа прав человека им. Елены Боннэр, Волонтерский центр, медиапроекты) продолжают работу в измененных форматах.",
                community_aspects: [
                    "Создание открытой площадки для дискуссий, выставок, лекций (в прошлом).",
                    "Организация образовательных программ (Школа прав человека).",
                    "Активное вовлечение волонтеров в различные проекты центра.",
                    "Развитие медиапроектов («Страна и мир», «Радио Сахаров») для широкой аудитории.",
                    "Формирование сообщества вокруг ценностей свободы, демократии и прав человека, адаптация к работе в изгнании."
                ],
                link: "https://www.sakharov-center.ru/archive/projects/", 
                disclaimer: "* Сахаровский центр ликвидирован решением суда в РФ в 2023 г. Многие его проекты продолжают деятельность как независимые инициативы, в том числе из-за рубежа."
            },
            {
                id: "vera_fund",
                title: "Фонд помощи хосписам «Вера»",
                color: "#20c997", // Teal
                tags: ["Паллиативная помощь", "Благотворительность", "Волонтерство", "Медицина", "Просвещение", "В России (стабильно)"],
                description: "Благотворительный фонд, системно занимающийся поддержкой хосписов и развитием паллиативной помощи в России.",
                community_aspects: [
                    "Адресная помощь пациентам и их семьям, создание поддерживающего окружения.",
                    "Развитие масштабного волонтерского движения в хосписах.",
                    "Обучение персонала хосписов, сиделок и родственников пациентов.",
                    "Информационно-просветительская деятельность, изменение общественного отношения к паллиативной помощи.",
                    "Привлечение широкого круга доноров и корпоративных партнеров."
                ],
                link: "https://fondvera.ru/",
                disclaimer: null
            },
            {
                id: "mediazona",
                title: "Медиазона*",
                color: "#fd7e14", // Orange
                tags: ["Медиа", "Права человека", "Мониторинг", "Расследования", "Давление/Блокировки", "В России/В изгнании"],
                description: "Независимое медиа-издание, освещающее деятельность судов, правоохранительных органов и пенитенциарной системы в России, а также нарушения прав человека.",
                community_aspects: [
                    "Создание уникального и востребованного контента, формирующего лояльную аудиторию.",
                    "Активное использование социальных сетей для распространения информации и взаимодействия с читателями.",
                    "Краудфандинг и система регулярных пожертвований от читателей как основа финансовой независимости.",
                    "Защита журналистов и источников информации в условиях давления.",
                    "Адаптация к блокировкам, использование VPN и альтернативных каналов распространения."
                ],
                link: "https://zona.media/",
                disclaimer: "* Издание признано Минюстом РФ «иностранным агентом». Сайт может быть заблокирован в РФ."
            },
            {
                id: "memorial",
                title: "Мемориал (Международный Мемориал / ПЦ \"Мемориал\")*",
                color: "#6610f2", // Indigo
                tags: ["Права человека", "История", "Политические репрессии", "Архивы", "Просвещение", "Юридическая помощь", "Ликвидирована в РФ", "В изгнании/Продолжение деятельности"],
                description: "Историко-просветительское, правозащитное и благотворительное общество, занимаавшееся исследованием политических репрессий в СССР и современной России, защитой прав человека. Структуры продолжают работу несмотря на ликвидацию.",
                community_aspects: [
                    "Поддержка исследователей, работа с архивами, сохранение исторической памяти.",
                    "Организация выставок, лекций, конференций и публичных мероприятий (в прошлом в РФ, продолжается за рубежом).",
                    "Оказание юридической помощи жертвам политических репрессий и их потомкам.",
                    "Международное сотрудничество и формирование глобального сообщества поддержки.",
                    "Продолжение деятельности через дочерние или партнерские организации после ликвидации основных юридических лиц в РФ."
                ],
                link: "https://www.memo.ru/",
                disclaimer: "* Международный Мемориал и Правозащитный центр «Мемориал» ликвидированы в РФ и признаны «иностранными агентами»."
            },
            {
                id: "golos",
                title: "Движение «Голос»*",
                color: "#17a2b8", // Info Blue
                tags: ["Наблюдение за выборами", "Права избирателей", "Мониторинг", "Волонтерство", "Давление/Блокировки", "В России"],
                description: "Движение в защиту прав избирателей, специализирующееся на общественном наблюдении за выборами и электоральными процессами в России.",
                community_aspects: [
                    "Обучение и координация тысяч независимых наблюдателей по всей стране.",
                    "Сбор сообщений о нарушениях через «Карту нарушений» и горячие линии.",
                    "Аналитика и экспертные доклады по избирательному законодательству и практикам.",
                    "Привлечение общественного внимания к проблемам выборов через медиа и публичные кампании.",
                    "Опора на волонтерскую сеть и пожертвования граждан."
                ],
                link: "https://www.golosinfo.org/",
                disclaimer: "* Признан Минюстом РФ «иностранным агентом». Подвергается давлению."
            },
            {
                id: "russia_behind_bars",
                title: "Русь Сидящая / Russia Behind Bars*",
                color: "#343a40", // Dark
                tags: ["Права заключенных", "Юридическая помощь", "Гуманитарная помощь", "Волонтерство", "Давление/Релокация", "В России/В изгнании"],
                description: "Благотворительный фонд и общественное движение, оказывающее юридическую, информационную и гуманитарную помощь заключенным и их семьям в России.",
                community_aspects: [
                    "Организация сбора передач и помощи для заключенных.",
                    "Предоставление юридических консультаций и защита прав в пенитенциарной системе.",
                    "Информирование общества о проблемах тюремной системы и нарушениях прав заключенных.",
                    "Поддержка семей заключенных, создание групп взаимопомощи.",
                    "Работа с волонтерами для оказания помощи на местах."
                ],
                link: "https://supportzeichen.org/", // Один из актуальных сайтов
                disclaimer: "* Основательница и некоторые сотрудники признаны «иностранными агентами»."
            },
            {
                id: "agora",
                title: "Международная Агора*",
                color: "#6f42c1", // Purple (same as header for consistency or choose another one)
                tags: ["Юридическая помощь", "Права человека", "Защита активистов", "Международные суды", "Давление/Релокация", "В России/В изгнании"],
                description: "Международная правозащитная группа, объединяющая адвокатов и юристов для оказания правовой помощи по делам о нарушении прав человека, включая представительство в ЕСПЧ и других международных инстанциях.",
                community_aspects: [
                    "Ведение стратегических судебных дел, имеющих общественное значение.",
                    "Защита журналистов, активистов, НКО, подвергающихся преследованиям.",
                    "Публикация аналитических материалов и докладов о состоянии прав человека.",
                    "Формирование сети квалифицированных адвокатов, готовых работать по сложным делам.",
                    "Привлечение внимания к нарушениям прав человека на международном уровне."
                ],
                link: "https://agora.legal/",
                disclaimer: "* Ассоциированные юристы и организация подвергались давлению, некоторые признаны «иностранными агентами». В 2023 году Генпрокуратура РФ признала деятельность «нежелательной»."
            },
            {
                id: "teplitsa",
                title: "Теплица социальных технологий*",
                color: "#28a745", // Green
                tags: ["IT для НКО", "Цифровая безопасность", "Образование", "Ресурсный центр", "Давление/Блокировки", "В России/В изгнании"],
                description: "Образовательный проект и ресурсный центр, помогающий НКО и гражданским активистам использовать цифровые технологии для решения социальных проблем и защиты прав.",
                community_aspects: [
                    "Проведение обучающих программ, вебинаров, мастер-классов по IT-инструментам и безопасности.",
                    "Разработка и поддержка полезных онлайн-сервисов и инструментов для НКО.",
                    "Создание сообщества IT-специалистов, дизайнеров, готовых помогать НКО (IT-волонтерство).",
                    "Консультации по цифровой безопасности и инфраструктуре для активистов и организаций.",
                    "Публикация гайдов, исследований и новостей в сфере гражданских технологий."
                ],
                link: "https://te-st.ru/",
                disclaimer: "* Признана Минюстом РФ «иностранным агентом» и «нежелательной организацией»."
            },
            {
                id: "nasiliunet",
                title: "Насилию.нет*",
                color: "#d63384", // Pink
                tags: ["Домашнее насилие", "Женские права", "Юридическая помощь", "Психологическая помощь", "Волонтерство", "Давление/Блокировки", "В России"],
                description: "Центр по работе с проблемой насилия, оказывающий комплексную помощь пострадавшим от домашнего насилия и занимающийся просветительской деятельностью.",
                community_aspects: [
                    "Организация работы горячей линии и предоставление кризисных консультаций.",
                    "Оказание юридической и психологической поддержки пострадавшим.",
                    "Проведение образовательных программ и кампаний по профилактике насилия.",
                    "Адвокация за принятие закона о профилактике домашнего насилия.",
                    "Привлечение волонтеров и сбор пожертвований для обеспечения работы центра."
                ],
                link: "https://nasiliu.net/",
                disclaimer: "* Признан Минюстом РФ «иностранным агентом»."
            }
        ];


        // --- 7.1. Отображение Кейсов ---
        const caseStudiesContainer = document.getElementById('caseStudiesContainer');

        function renderCases(casesToRender, container) {
            container.innerHTML = '';
            if (casesToRender.length === 0) {
                container.innerHTML = `<div class="col-12"><p class="no-cases-found">По вашему запросу кейсы не найдены. Попробуйте изменить критерии.</p></div>`;
                gsap.fromTo(".no-cases-found", {opacity:0, y:20}, {opacity:1, y:0, duration:0.5});
                return;
            }

            casesToRender.forEach((caseItem, index) => {
                const cardCol = document.createElement('div');
                cardCol.className = 'col-lg-6 col-md-12 mb-4';
                
                const card = document.createElement('div');
                card.className = 'case-study-card h-100';
                card.style.setProperty('--case-color', caseItem.color);
                card.style.borderLeftColor = caseItem.color;

                let tagsHtml = '<div class="tags mb-2">';
                caseItem.tags.forEach(tag => {
                    tagsHtml += `<span class="badge" style="background-color: ${caseItem.color}26; color: ${caseItem.color};">${tag}</span>`; // Lighter background for tags
                });
                tagsHtml += '</div>';

                let aspectsHtml = '<ul>';
                caseItem.community_aspects.forEach(aspect => {
                    aspectsHtml += `<li>${aspect}</li>`;
                });
                aspectsHtml += '</ul>';

                card.innerHTML = `
                    <h5>${caseItem.title}</h5>
                    ${tagsHtml}
                    <p>${caseItem.description}</p>
                    <strong>Ключевые аспекты комьюнити/устойчивости:</strong>
                    ${aspectsHtml}
                    ${caseItem.link ? `<p><a href="${caseItem.link}" target="_blank" rel="noopener noreferrer" class="case-link">Перейти на сайт</a></p>` : ''}
                    ${caseItem.disclaimer ? `<p class="disclaimer">${caseItem.disclaimer}</p>` : ''}
                `;
                cardCol.appendChild(card);
                container.appendChild(cardCol);

                gsap.to(card, {
                    opacity: 1, y: 0, duration: 0.5, delay: index * 0.08, // Faster stagger
                    scrollTrigger: { trigger: card, start: "top 90%", once: true, markers: false }
                });
            });
        }
        
        if (caseStudiesContainer) {
            renderCases(caseData, caseStudiesContainer); // Initial render of all cases
        }

        // --- 7.2. Интерактив: Подбор релевантных кейсов ---
         const interestAreas = Array.from(new Set(caseData.flatMap(c => c.tags.filter(t => !["В России", "Давление/Блокировки", "Релокация части команды", "Ликвидирована в РФ", "В изгнании/Продолжение деятельности", "В России (стабильно)", "В России/В изгнании"].includes(t))))).sort();
        const operatingConditions = Array.from(new Set(caseData.flatMap(c => c.tags.filter(t => ["В России", "Давление/Блокировки", "Релокация части команды", "Ликвидирована в РФ", "В изгнании/Продолжение деятельности", "В России (стабильно)", "В России/В изгнании"].includes(t))))).sort();

        const interestTilesContainer = document.getElementById('interestTilesContainer');
        const conditionTilesContainer = document.getElementById('conditionTilesContainer');
        const matchNPOsBtn = document.getElementById('matchNPOsBtn');
        const matchedCasesContainer = document.getElementById('matchedCasesContainer');

        function createTile(value, idPrefix) {
            const tile = document.createElement('span'); // Using span for inline-block nature
            tile.className = 'filter-tile';
            tile.dataset.value = value;
            tile.id = `${idPrefix}-${value.replace(/[\s\/]+/g, '')}`; // Create a safe ID
            tile.textContent = value;
            tile.setAttribute('role', 'button'); // For accessibility
            tile.setAttribute('tabindex', '0'); // Make it focusable

            tile.addEventListener('click', () => {
                tile.classList.toggle('active');
                gsap.to(tile, { 
                    scale: tile.classList.contains('active') ? 1.05 : 1, 
                    y: tile.classList.contains('active') ? -2 : 0,
                    duration: 0.15, 
                    ease: "power1.out" 
                });
            });
            // Allow activation with Enter/Space for accessibility
            tile.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    tile.click();
                }
            });
            return tile;
        }

        function populateFilters() {
            if (interestTilesContainer) {
                interestTilesContainer.innerHTML = ''; 
                interestAreas.forEach(area => {
                    interestTilesContainer.appendChild(createTile(area, 'interest'));
                });
            }
            if (conditionTilesContainer) {
                conditionTilesContainer.innerHTML = ''; 
                 operatingConditions.forEach(condition => {
                    conditionTilesContainer.appendChild(createTile(condition, 'condition'));
                });
            }
            
            // GSAP animation for tiles appearance
            gsap.utils.toArray('#npoMatcherSection .filter-tile').forEach((tile, i) => {
                 gsap.to(tile, {
                    opacity: 1, 
                    scale: 1,
                    y: 0, 
                    duration: 0.5, 
                    delay: 0.1 + i * 0.04, // Slightly adjusted delay
                    ease: "back.out(1.6)", // Adjusted ease
                    scrollTrigger: { 
                        trigger: tile.parentElement, 
                        start: "top 90%", // Start animation when container is almost visible
                        once: true
                    }
                });
            });
        }
        
        if (interestTilesContainer && conditionTilesContainer && matchNPOsBtn && matchedCasesContainer) {
            populateFilters();

            matchNPOsBtn.addEventListener('click', () => {
                const selectedInterests = Array.from(interestTilesContainer.querySelectorAll('.filter-tile.active')).map(tile => tile.dataset.value);
                const selectedConditions = Array.from(conditionTilesContainer.querySelectorAll('.filter-tile.active')).map(tile => tile.dataset.value);

                const filteredCases = caseData.filter(caseItem => {
                    // НОВАЯ ЛОГИКА: соответствие хотя бы одному из выбранных критериев
                    // Если ни один интерес не выбран, считаем, что по интересам подходит (чтобы показать все по условиям)
                    const matchesInterests = selectedInterests.length === 0 || selectedInterests.some(interest => caseItem.tags.includes(interest));
                    
                    // Если ни одно условие не выбрано, считаем, что по условиям подходит (чтобы показать все по интересам)
                    const matchesConditions = selectedConditions.length === 0 || selectedConditions.some(condition => caseItem.tags.includes(condition));

                    // Карточка должна соответствовать ИЛИ интересам (если они выбраны) ИЛИ условиям (если они выбраны)
                    // Если выбраны и те, и другие, то она должна соответствовать И тому, И другому.
                    // Если не выбрано ничего, показываем все.
                    if (selectedInterests.length > 0 && selectedConditions.length > 0) {
                        return matchesInterests && matchesConditions;
                    } else if (selectedInterests.length > 0) {
                        return matchesInterests;
                    } else if (selectedConditions.length > 0) {
                        return matchesConditions;
                    } else {
                        return true; // Если ничего не выбрано, показываем все кейсы
                    }
                });
                
                // ... остальной код обработчика (анимация и рендеринг) остается без изменений ...
                const scrollTarget = document.getElementById('npoMatcherSection').querySelector('h4'); 
                const existingCards = matchedCasesContainer.querySelectorAll('.case-study-card');

                if (existingCards.length > 0) {
                    gsap.to(existingCards, {
                        opacity: 0,
                        y: 20,
                        scale: 0.95,
                        stagger: 0.05,
                        duration: 0.3,
                        ease: "power1.in",
                        onComplete: () => {
                            renderCases(filteredCases, matchedCasesContainer); 
                            if (scrollTarget) { 
                                gsap.to(window, {
                                    duration: 0.5, 
                                    scrollTo: { 
                                        y: scrollTarget, 
                                        offsetY: 20 
                                    }, 
                                    ease: "power2.inOut"
                                });
                            } else if (filteredCases.length > 0) {
                                 gsap.to(window, {
                                    duration: 0.5, 
                                    scrollTo: { y: matchedCasesContainer, offsetY: 20 }, 
                                    ease: "power2.inOut"
                                });
                            }
                        }
                    });
                } else {
                     renderCases(filteredCases, matchedCasesContainer);
                     if (scrollTarget) {
                        gsap.to(window, {
                            duration: 0.5, 
                            scrollTo: { y: scrollTarget, offsetY: 20 }, 
                            ease: "power2.inOut"
                        });
                     } else if (filteredCases.length > 0) {
                         gsap.to(window, {
                            duration: 0.5, 
                            scrollTo: { y: matchedCasesContainer, offsetY: 20 }, 
                            ease: "power2.inOut"
                        });
                     }
                }
            });
        }


        // --- 7.3. AI Советник ---
        const getAICaseAdviceBtn = document.getElementById('getAICaseAdviceBtn');
        const aiCaseAdviceContainer = document.getElementById('aiCaseAdviceContainer');
        const aiCaseAdviceResultEl = document.getElementById('aiCaseAdviceResult');

        // --- GOOGLE AI API CONSTANTS ---
        const GOOGLE_AI_API_KEY = "AIzaSyDl6bLHj4tFonVVBnKDhgIpdrTQuZXmhqo";
        const GOOGLE_AI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/";
        const GOOGLE_AI_MODEL = "gemma-3n-e4b-it";
        const GOOGLE_AI_API_URL = `${GOOGLE_AI_API_URL_BASE}${GOOGLE_AI_MODEL}:generateContent?key=${GOOGLE_AI_API_KEY}`;

        if (getAICaseAdviceBtn && aiCaseAdviceContainer && aiCaseAdviceResultEl) {
            gsap.set(aiCaseAdviceContainer, {display: 'none', autoAlpha:0});

            getAICaseAdviceBtn.addEventListener('click', async () => {
                const npoDescription = document.getElementById('npoDescriptionForAI').value;
                if (!npoDescription.trim()) {
                    alert("Пожалуйста, опишите вашу НКО и вызовы.");
                    return;
                }
                gsap.timeline().set(aiCaseAdviceContainer, {display: 'block'}).to(aiCaseAdviceContainer, {autoAlpha:1, y:0, duration:0.4, ease: 'power2.out'});
                aiCaseAdviceResultEl.innerHTML = '<em>👩‍💻 ИИ анализирует ваш запрос и подбирает кейсы...</em>';
                gsap.fromTo(aiCaseAdviceResultEl, {opacity:0.5, y:5}, {opacity:1, y:0, duration:0.3});

                let caseSummaries = "Представленные кейсы для анализа:\n";
                caseData.forEach(c => {
                    caseSummaries += `- ${c.title}: ${c.description.substring(0,120)}...\n  Теги: ${c.tags.join(', ')}\n\n`;
                });

                try {
                    // Системный промпт включаем в userPrompt (как на других страницах)
                    const systemPrompt = "Ты — ИИ-консультант по развитию НКО и правозащитной деятельности. Твоя задача — проанализировать описание НКО пользователя и, основываясь на предоставленных тобой кратких описаниях кейсов, посоветовать 1-3 наиболее релевантных кейса для изучения. Кратко объясняй свой выбор, фокусируясь на практической пользе для пользователя. Ответ на русском языке.";
                    const userPrompt = `${systemPrompt}\n\nПользователь описывает свою (или планируемую) НКО и её вызовы: \"${npoDescription}\".\n${caseSummaries}\nИсходя из описания пользователя и предоставленных кейсов, порекомендуй 1-3 наиболее релевантных кейса для более детального изучения. Кратко (1-2 предложения на кейс) объясни, почему именно эти кейсы могут быть полезны данному пользователю, на какие аспекты их деятельности ему стоит обратить внимание в контексте его запроса. Ответ на русском. Будь краток и сфокусируйся на практической пользе.`;
                    const requestPayload = {
                        contents: [{
                            role: "user",
                            parts: [{ "text": userPrompt }]
                        }],
                        generationConfig: {
                            temperature: 0.6,
                            maxOutputTokens: 700
                        }
                    };
                    const response = await fetch(GOOGLE_AI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestPayload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: { message: 'Unknown error format' } }));
                        console.error("Google AI API Error Data:", errorData);
                        throw new Error(`Ошибка сети: ${response.status} - ${errorData.error?.message || response.statusText || 'Unknown error'}`);
                    }
                    const data = await response.json();
                    let aiMessage = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Не удалось получить совет от ИИ.";
                    aiMessage = aiMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
                    if (aiMessage.includes('<li>')) { aiMessage = aiMessage.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); aiMessage = aiMessage.replace(/<\/ul>\s*<ul>/g, '');}
                    aiMessage = aiMessage.replace(/\n/g, '<br>');
                    gsap.to(aiCaseAdviceResultEl, {opacity:0, y: -5, duration: 0.2, onComplete: () => {
                        aiCaseAdviceResultEl.innerHTML = aiMessage;
                        gsap.to(aiCaseAdviceResultEl, {opacity:1, y:0, duration:0.4, ease: 'power2.out'});
                    }});
                } catch (error) {
                    console.error('AI Case Advice Error:', error);
                    gsap.to(aiCaseAdviceResultEl, {opacity:0, y: -5, duration: 0.2, onComplete: () => {
                        aiCaseAdviceResultEl.innerHTML = `😥 Ошибка получения совета от ИИ. <small>${error.message}</small>`;
                        gsap.to(aiCaseAdviceResultEl, {opacity:1, y:0, duration:0.4, ease: 'power2.out'});
                    }});
                }
            });
        }
        
        // --- PDF Экспорт ---
        const exportCasesResultsBtn = document.getElementById('exportCasesResultsBtn');
        if (exportCasesResultsBtn) {
            exportCasesResultsBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                
                if (window.QanelasRegularFontData && window.QanelasRegularFontData.base64) {
                    doc.addFileToVFS('Qanelas-Regular.ttf', window.QanelasRegularFontData.base64);
                    doc.addFont('Qanelas-Regular.ttf', 'Qanelas', 'normal');
                }
                doc.setFont('Qanelas', 'normal');

                const pageWidth = doc.internal.pageSize.getWidth();
                let y = 40;

                doc.setFontSize(20);
                doc.setTextColor(111, 66, 193); // Purple
                doc.text("Раздел 7: Кейсы и Практика", pageWidth / 2, y, { align: 'center' });
                y += 30;

                const npoUserDescription = document.getElementById('npoDescriptionForAI').value;
                if (npoUserDescription.trim()){
                    doc.setFontSize(12);
                    doc.setTextColor(52,58,64);
                    doc.text("Описание НКО пользователя для AI Советника:", 40, y);
                    y+=15;
                    doc.setFontSize(10);
                    doc.setTextColor(85,85,85);
                    const descLines = doc.splitTextToSize(npoUserDescription, pageWidth - 80);
                    doc.text(descLines, 40, y);
                    y += descLines.length * 12 + 10;
                }

                const aiAdvice = aiCaseAdviceResultEl.innerText;
                 if (aiAdvice && aiAdvice.trim() && !aiAdvice.includes("Заполните описание") && !aiAdvice.includes("ИИ анализирует")) {
                    if (y > 700) { doc.addPage(); y = 40; }
                    doc.setFontSize(12);
                    doc.setTextColor(111, 66, 193);
                    doc.text("Совет от ИИ:", 40, y);
                    y += 18;
                    doc.setFontSize(10);
                    doc.setTextColor(85, 85, 85);
                    // Преобразуем <br> и <li> обратно или просто используем innerText
                    let plainTextAdvice = aiCaseAdviceResultEl.innerHTML.replace(/<br\s*[\/]?>/gi, "\n").replace(/<\/?strong>/gi, "").replace(/<\/?em>/gi, "").replace(/<\/?ul>/gi, "").replace(/<li>/gi, "\n- ").replace(/<\/li>/gi, "");
                    plainTextAdvice = new DOMParser().parseFromString(plainTextAdvice, "text/html").documentElement.textContent; // Убираем остатки HTML

                    const adviceLines = doc.splitTextToSize(plainTextAdvice, pageWidth - 80);
                    doc.text(adviceLines, 40, y);
                    y += adviceLines.length * 12 + 10;
                }


                doc.setFontSize(14);
                doc.setTextColor(52, 58, 64); 
                doc.text("Выбранные/релевантные кейсы НКО:", 40, y);
                y += 20;

                const casesToExport = [];
                const matchedCaseElements = matchedCasesContainer.querySelectorAll('.case-study-card');
                
                if (matchedCaseElements.length > 0 && matchedCasesContainer.innerHTML.includes('case-study-card')) { 
                    matchedCaseElements.forEach(cardEl => {
                        const title = cardEl.querySelector('h5')?.innerText || 'Без названия';
                        const originalCase = caseData.find(c => c.title === title.replace('*','').trim()); 
                        if (originalCase) {
                            casesToExport.push(originalCase);
                        }
                    });
                } else if (caseStudiesContainer.innerHTML.includes('case-study-card') && matchedCasesContainer.innerHTML.includes('По вашему запросу кейсы не найдены')) {
                     // Ничего не добавляем
                } else { 
                    casesToExport.push(...caseData);
                }


                if (casesToExport.length > 0) {
                    casesToExport.forEach(caseItem => {
                        if (y > 750) { doc.addPage(); y = 40; } 
                        doc.setFontSize(12);
                        doc.setTextColor(parseInt(caseItem.color.substring(1,3),16), parseInt(caseItem.color.substring(3,5),16), parseInt(caseItem.color.substring(5,7),16)); // Цвет из кейса
                        doc.text(caseItem.title, 40, y);
                        y += 15;

                        doc.setFontSize(9);
                        doc.setTextColor(108, 117, 125); 
                        const tagLines = doc.splitTextToSize(`Теги: ${caseItem.tags.join(', ')}`, pageWidth - 80);
                        doc.text(tagLines, 40, y);
                        y += tagLines.length * 11 + 5;
                        
                        if (y > 760) { doc.addPage(); y = 40; }
                        doc.setFontSize(10);
                        doc.setTextColor(85, 85, 85); 
                        const descLines = doc.splitTextToSize(`Описание: ${caseItem.description}`, pageWidth - 80);
                        doc.text(descLines, 40, y);
                        y += descLines.length * 12 + 5;
                        
                        if (y > 750) { doc.addPage(); y = 40; }
                        doc.text("Ключевые аспекты:", 40, y);
                        y += 12;
                        doc.setFontSize(9);
                        caseItem.community_aspects.forEach(aspect => {
                            if (y > 780) { doc.addPage(); y = 40; }
                            const aspectLines = doc.splitTextToSize(`- ${aspect}`, pageWidth - 90);
                            doc.text(aspectLines, 50, y);
                            y += aspectLines.length * 11 + 3;
                        });
                        
                        if (caseItem.disclaimer) {
                             if (y > 780) { doc.addPage(); y = 40; }
                            doc.setFontSize(8);
                            doc.setTextColor(150, 150, 150);
                            const disclaimerLines = doc.splitTextToSize(caseItem.disclaimer, pageWidth - 80);
                            doc.text(disclaimerLines, 40, y);
                            y += disclaimerLines.length * 10 + 5;
                        }
                        y += 15; 
                    });
                } else {
                     doc.setFontSize(10);
                     doc.setTextColor(85, 85, 85);
                     doc.text("Кейсы для экспорта не выбраны или не найдены.", 40, y);
                     y += 15;
                }
                doc.save('cases_and_practice_results.pdf');
            });
        }
        ScrollTrigger.refresh();
    });
    </script>
</body>
</html>