<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6. Антикризисное управление - Семинар НКО</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/animations.css">
    <style>
        body { padding-top: 70px; overflow-x: hidden; }
        .page-header-section {
            background: linear-gradient(135deg, #ff6a00 0%, #ffb347 100%);
            color: #212529;
            padding: 4rem 1.5rem; margin-bottom: 2rem; border-radius: .3rem; text-align: center;
        }
        .page-header-section img.header-icon { width: 80px; height: 80px; margin-bottom: 1rem; }
        .content-section { margin-bottom: 3rem; opacity: 0; transform: translateY(40px); }
        .content-section h3, .content-section h4 {
            margin-bottom: 1.5rem; display: flex; align-items: center;
            font-weight: 600; color: #343a40;
        }
        .content-section h3 img.section-icon, .content-section h4 img.section-icon {
            width: 32px; height: 32px; margin-right: 0.8rem; opacity: 0.8;
        }
        /* Карточки устойчивости */
        .resilience-card {
            background: #fff; border-radius: .7rem; box-shadow: 0 4px 16px rgba(0,0,0,0.09);
            padding: 2rem 1.5rem; margin-bottom: 1.5rem; transition: box-shadow 0.3s;
            cursor: pointer; opacity: 0; transform: translateY(30px);
        }
        .resilience-card.active { box-shadow: 0 8px 24px rgba(255,106,0,0.13); }
        .resilience-card .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: .5rem; }
        .resilience-card .card-icon { width: 36px; height: 36px; margin-right: .7rem; vertical-align: middle; }
        /* Чек-лист */
        .crisis-checklist { background: #fffbe6; border-radius: .6rem; padding: 2rem 1.5rem; box-shadow: 0 2px 10px rgba(255,106,0,0.07); }
        .crisis-checklist ul { list-style: none; padding-left: 0; }
        .crisis-checklist li { margin-bottom: 1.1rem; padding: .7rem 1rem; border-radius: .4rem; border: 1px solid #ffe0b2; background: #fff; cursor: pointer; display: flex; align-items: center; transition: background 0.2s, border 0.2s; }
        .crisis-checklist li.checked { background: #e9f5e9; border-color: #c3e6cb; }
        .crisis-checklist .check-icon { color: #ff9800; font-size: 1.3rem; margin-right: .7rem; transition: color 0.2s; }
        .crisis-checklist li.checked .check-icon { color: #43a047; }
        /* Шаблон плана */
        .crisis-plan-template { background: #f8f9fa; border-radius: .6rem; padding: 2rem 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); margin-bottom: 2rem; }
        .crisis-plan-template .template-row { margin-bottom: 1.2rem; }
        .crisis-plan-template label { font-weight: 500; }
        .crisis-plan-template textarea, .crisis-plan-template input { font-size: 1rem; }
        .collapse-btn { background: none; border: none; color: #ff6a00; font-weight: 600; cursor: pointer; margin-bottom: 1rem; }
        /* Кейс-анализ */
        .case-block { background: #fff; border-radius: .7rem; box-shadow: 0 4px 16px rgba(0,0,0,0.09); padding: 2rem 1.5rem; margin-bottom: 2rem; opacity: 0; transform: translateY(30px); }
        .case-block .case-title { font-size: 1.1rem; font-weight: 600; margin-bottom: .7rem; }
        .case-block .case-desc { color: #555; margin-bottom: 1.2rem; }
        .case-block .case-steps { display: none; margin-top: 1.2rem; }
        .case-block.active .case-steps { display: block; }
        .case-block .btn-analyze { background: #ff9800; color: #fff; border: none; border-radius: .3rem; padding: .5rem 1.2rem; font-weight: 500; transition: background 0.2s; }
        .case-block .btn-analyze:hover { background: #ff6a00; }
    </style>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="../index.html">
                <img src="../assets/images/logo.svg" alt="Лого НКО">
                Семинар НКО
            </a>
            <button class="navbar-custom-toggler ms-auto" aria-label="Открыть меню" id="customMenuToggler" aria-expanded="false">
                <svg viewBox="0 0 100 80" width="30" height="30" id="actualBurgerIcon" fill="currentColor">
                    <rect class="line line1" x="0" y="10" width="100" height="10" rx="5"></rect>
                    <rect class="line line2" x="0" y="35" width="100" height="10" rx="5"></rect>
                    <rect class="line line3" x="0" y="60" width="100" height="10" rx="5"></rect>
                </svg>
            </button>
        </div>
    </nav>
</header>
<div class="fullscreen-menu" id="fullscreenMenu">
    <button class="close-menu-btn" id="closeFullscreenMenu" aria-label="Закрыть меню">×</button>
    <ul class="navbar-nav-fullscreen">
        <li class="nav-item fs-menu-item"><a class="nav-link" href="../index.html">Главная</a></li>
        <li class="nav-item fs-menu-item custom-dropdown">
            <a class="nav-link dropdown-toggle-custom active" href="#" id="sectionsDropdownCustomFs" role="button" aria-expanded="false">Разделы</a>
            <ul class="dropdown-menu-custom">
                <li><a class="dropdown-item" href="0_introduction.html">0. Введение</a></li>
                <li><a class="dropdown-item" href="1_community_building.html">1. Сообщество</a></li>
                <li><a class="dropdown-item" href="2_internal_communications.html">2. Коммуникации</a></li>
                <li><a class="dropdown-item" href="3_infrastructure.html">3. Инфраструктура</a></li>
                <li><a class="dropdown-item" href="4_legal_and_security.html">4. Безопасность</a></li>
                <li><a class="dropdown-item" href="5_effectiveness_and_development.html">5. Эффективность</a></li>
                <li><a class="dropdown-item active" href="6_crisis_management.html">6. Антикризис</a></li>
                <li><a class="dropdown-item" href="7_cases_and_practice.html">7. Практика</a></li>
            </ul>
        </li>
        <li class="nav-item fs-menu-item"><a class="nav-link" href="useful_resources.html">Полезные ресурсы</a></li>
    </ul>
</div>
<main>
    <div class="page-header-section">
        <img src="../assets/icons/crisis.svg" alt="Антикризисное управление" class="header-icon">
        <h1 class="display-5 fw-bold">Раздел 6: Антикризисное управление</h1>
        <p class="lead">Готовимся к неожиданностям: устойчивость, быстрый ответ и разбор реальных кейсов для НКО.</p>
    </div>
    <div class="container py-4">
        <!-- 6.1. Опоры устойчивости -->
        <section class="content-section" id="s6-1">
            <h3><img src="../assets/icons/community.svg" alt="Опоры устойчивости" class="section-icon">6.1. НКО в Кризис: Опоры Устойчивости</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Сообщество">
                        <span class="card-title"><img src="../assets/icons/groups.svg" class="card-icon">Сообщество</span>
                        <div class="card-text">Сильное ядро сторонников и волонтеров помогает быстро мобилизоваться, делиться ресурсами и поддерживать друг друга в трудные времена.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Коммуникации">
                        <span class="card-title"><img src="../assets/icons/communication.svg" class="card-icon">Коммуникации</span>
                        <div class="card-text">Налаженные внутренние и внешние коммуникации позволяют быстро реагировать, информировать команду и партнеров, предотвращать панику.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Инфраструктура">
                        <span class="card-title"><img src="../assets/icons/Infrastructure.svg" class="card-icon">Инфраструктура</span>
                        <div class="card-text">Резервные каналы связи, бэкапы данных, защищённые облачные сервисы и альтернативные инструменты обеспечивают непрерывность работы.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Безопасность">
                        <span class="card-title"><img src="../assets/icons/safety.svg" class="card-icon">Безопасность</span>
                        <div class="card-text">Юридическая, информационная и психологическая безопасность — залог устойчивости. Важно заранее знать, куда обращаться и что делать.</div>
                    </div>
                </div>
            </div>
        </section>
        <!-- 6.2. Чек-лист "Тревожный чемоданчик НКО" -->
        <section class="content-section" id="s6-2">
            <h3><img src="../assets/icons/warning.svg" alt="Чек-лист" class="section-icon">6.2. Чек-лист "Тревожный чемоданчик НКО"</h3>
            <div class="crisis-checklist">
                <ul id="crisisChecklistUl">
                    <li><span class="check-icon">✔</span><b>Юридический:</b> Контакты адвокатов, копии уставных документов (в облаке), шаблоны заявлений</li>
                    <li><span class="check-icon">✔</span><b>Информационный:</b> Резервные каналы связи, бэкапы данных, план коммуникаций в кризис</li>
                    <li><span class="check-icon">✔</span><b>Финансовый:</b> Резервный фонд, альтернативные способы получения/распределения средств</li>
                    <li><span class="check-icon">✔</span><b>Психологический:</b> Контакты психологов, памятка по самопомощи</li>
                </ul>
                <form id="addChecklistItemForm" class="d-flex gap-2 mt-3" autocomplete="off" onsubmit="return false;">
                    <input type="text" class="form-control" id="newChecklistItemInput" placeholder="Добавить свой пункт...">
                    <button type="submit" class="btn btn-outline-warning">Добавить</button>
                </form>
                <div class="mt-2 text-muted" style="font-size:0.97rem;">Кликните по пункту для отметки готовности. Двойной клик по своему пункту — удалить.</div>
            </div>
        </section>
        <!-- 6.3. Шаблон плана реагирования -->
        <section class="content-section" id="s6-3">
            <h3><img src="../assets/icons/practical.svg" alt="План реагирования" class="section-icon">6.3. Шаблон "План реагирования на кризисную ситуацию"</h3>
            <button class="collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#crisisPlanCollapse" aria-expanded="false">Показать/скрыть шаблон</button>
            <div class="collapse show crisis-plan-template" id="crisisPlanCollapse">
                <form id="crisisPlanForm">
                    <div class="template-row mb-3">
                        <label>Название кризисной ситуации:</label>
                        <input type="text" class="form-control" name="situation" placeholder="Например, 'Блокировка счета'">
                    </div>
                    <div class="template-row mb-3">
                        <label>Возможные триггеры/признаки:</label>
                        <textarea class="form-control" name="triggers" rows="2"></textarea>
                    </div>
                    <div class="template-row mb-3">
                        <label>Ответственные лица (основной, заместитель):</label>
                        <input type="text" class="form-control" name="responsibles" placeholder="ФИО, контакты">
                    </div>
                    <div class="template-row mb-3">
                        <label>Протокол немедленных действий:</label>
                        <textarea class="form-control" name="actions" rows="2" placeholder="Шаг 1, 2, 3..."></textarea>
                    </div>
                    <div class="template-row mb-3">
                        <label>Внутренние коммуникации:</label>
                        <textarea class="form-control" name="internal_comms" rows="2" placeholder="Кого, как, о чем информировать"></textarea>
                    </div>
                    <div class="template-row mb-3">
                        <label>Внешние коммуникации:</label>
                        <textarea class="form-control" name="external_comms" rows="2" placeholder="Целевая аудитория, ключевое сообщение, каналы, спикер"></textarea>
                    </div>
                    <div class="template-row mb-3">
                        <label>Необходимые ресурсы:</label>
                        <textarea class="form-control" name="resources" rows="2" placeholder="Контакты, документы, финансы"></textarea>
                    </div>
                    <div class="template-row mb-3">
                        <label>Пост-кризисный анализ и уроки:</label>
                        <textarea class="form-control" name="lessons" rows="2" placeholder="Что улучшить на будущее"></textarea>
                    </div>
                    <button type="button" class="btn btn-warning text-dark mt-2" id="getCrisisPlanAiFeedbackBtn">Получить обратную связь от ИИ</button>
                </form>
                <div id="aiCrisisPlanFeedbackContainer" class="mt-4" style="display:none;">
                    <h5 class="text-primary">Комментарий от ИИ по вашему плану:</h5>
                    <div id="aiCrisisPlanFeedbackResult" class="p-3 border rounded bg-light-subtle text-muted"><em>Заполните шаблон и нажмите кнопку...</em></div>
                </div>
            </div>
        </section>
        <!-- 6.4. Интерактив: Разбор кейса -->
        <section class="content-section" id="s6-4">
            <h3><img src="../assets/icons/cases.svg" alt="Кейс" class="section-icon">6.4. Интерактив: Разбор кейса</h3>
            <div class="case-block" id="caseBlock">
                <div class="case-title">Кейс: Блокировка банковского счета НКО</div>
                <div class="case-desc">Ваша организация внезапно сталкивается с блокировкой основного расчетного счета. Оборудование изымается для проверки. Как действовать? Используйте шаблон плана реагирования и предложите шаги.</div>
                <button class="btn-analyze" id="showCaseStepsBtn">Показать примерный разбор</button>
                <div class="case-steps" id="caseSteps">
                    <ol>
                        <li>Оперативно уведомить руководство и ключевых сотрудников.</li>
                        <li>Связаться с адвокатами, подготовить копии документов.</li>
                        <li>Перевести коммуникации в резервные каналы.</li>
                        <li>Оценить финансовые резервы, при необходимости — информировать доноров.</li>
                        <li>Провести внутренний брифинг, поддержать команду психологически.</li>
                        <li>После разрешения — провести анализ, обновить "тревожный чемоданчик".</li>
                    </ol>
                </div>
            </div>
        </section>
    </div>
</main>
<footer class="py-4 bg-dark text-white-50 mt-5">
    <div class="container text-center">
        <small>Материалы семинара © 2024.</small> <br>
        <small><em>Информация на сайте носит ознакомительный характер и не является юридической консультацией. Для принятия решений всегда обращайтесь к квалифицированным специалистам.</em></small>
        <div class="mt-4">
            <button class="btn btn-success" id="exportCrisisResultsBtn">Выгрузить результаты раздела</button>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script>
<script src="../assets/fonts/Qanelas-Regular.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    gsap.registerPlugin(ScrollTrigger);
    // --- Меню (аналогично другим страницам) ---
    const customMenuToggler = document.getElementById('customMenuToggler');
    const fullscreenMenu = document.getElementById('fullscreenMenu');
    const closeFullscreenMenuBtn = document.getElementById('closeFullscreenMenu');
    if (customMenuToggler && fullscreenMenu) {
        const fsNav = fullscreenMenu.querySelector('.navbar-nav-fullscreen');
        const fsMenuItems = fsNav ? gsap.utils.toArray(fsNav.querySelectorAll('.fs-menu-item > a, .fs-menu-item > .dropdown-toggle-custom')) : [];
        const fsSubMenuItemsContainer = fsNav ? fsNav.querySelector('.fs-menu-item.custom-dropdown .dropdown-menu-custom') : null;
        const actualBurgerIcon = customMenuToggler.querySelector('svg');
        const burgerLine1 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line1') : null;
        const burgerLine2 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line2') : null;
        const burgerLine3 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line3') : null;
        let burgerTimeline = gsap.timeline({ paused: true, reversed: true });
        if (burgerLine1 && burgerLine2 && burgerLine3) {
            const line1YInitial = parseFloat(burgerLine1.getAttribute('y'));
            const line2YInitial = parseFloat(burgerLine2.getAttribute('y'));
            const line3YInitial = parseFloat(burgerLine3.getAttribute('y'));
            if (!isNaN(line1YInitial) && !isNaN(line2YInitial) && !isNaN(line3YInitial)) {
                burgerTimeline.to(burgerLine1,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross")
                    .to(burgerLine3,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross")
                    .to(burgerLine2,{duration:0.2,scaleX:0,transformOrigin:"50% 50%",ease:"power2.in"},"cross")
                    .to(burgerLine1,{duration:0.25,rotation:45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd")
                    .to(burgerLine3,{duration:0.25,rotation:-45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd");
            } else { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
        } else if (actualBurgerIcon) { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
        let fsMenuIsOpen = false;
        gsap.set(fullscreenMenu, { display: 'none', autoAlpha: 0 });
        if (fsMenuItems.length > 0) gsap.set(fsMenuItems, { autoAlpha: 0, y: 20 });
        if (fsSubMenuItemsContainer) gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
        const openFullscreenMenu = () => { if (fsMenuIsOpen) return; fsMenuIsOpen = true; fullscreenMenu.style.display = 'flex'; burgerTimeline.play(); customMenuToggler.classList.add('open'); customMenuToggler.setAttribute('aria-expanded', 'true'); const tlOpen = gsap.timeline(); tlOpen.to(fullscreenMenu, { autoAlpha: 1, duration: 0.35, ease: 'power1.out' }); if (fsMenuItems.length > 0) tlOpen.to(fsMenuItems, { autoAlpha: 1, y: 0, duration: 0.3, stagger: 0.06, ease: 'power1.out' }, "-=0.2"); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if (sectionsDropdownCustomFs && sectionsDropdownCustomFs.classList.contains('active') && fsSubMenuItemsContainer) { if (sectionsDropdownCustomFs.getAttribute('aria-expanded') === 'true' || fsSubMenuItemsContainer.style.height === 'auto') { tlOpen.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration: 0.2, stagger: 0.04, ease: 'power1.out' }, "-=0.1"); }}};
        const closeFullscreenMenu = () => { if (!fsMenuIsOpen) return; fsMenuIsOpen = false; burgerTimeline.reverse(); customMenuToggler.classList.remove('open'); customMenuToggler.setAttribute('aria-expanded', 'false'); const tlClose = gsap.timeline({onComplete: () => { fullscreenMenu.style.display = 'none'; if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10}); gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0}); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if(sectionsDropdownCustomFs) sectionsDropdownCustomFs.setAttribute('aria-expanded', 'false');}}}); if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { tlClose.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.15, stagger: {each:0.03, from:"end"}, ease:'power1.in' });} if (fsMenuItems.length > 0) tlClose.to(fsMenuItems, { autoAlpha: 0, y: 15, duration: 0.2, stagger: { each: 0.04, from: "end" }, ease: 'power1.in' }, fsSubMenuItemsContainer ? "-=0.1" : 0); tlClose.to(fullscreenMenu, { autoAlpha: 0, duration: 0.25, ease: 'power1.in' }, fsMenuItems.length > 0 ? "-=0.1" : 0); };
        customMenuToggler.addEventListener('click', () => { fsMenuIsOpen ? closeFullscreenMenu() : openFullscreenMenu(); });
        if (closeFullscreenMenuBtn) closeFullscreenMenuBtn.addEventListener('click', closeFullscreenMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && fsMenuIsOpen) closeFullscreenMenu(); });
        const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs');
        if (sectionsDropdownCustomFs && fsSubMenuItemsContainer) {
            gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop:0, marginBottom:0 }); gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
            let subMenuFsIsOpen = false;
            sectionsDropdownCustomFs.addEventListener('click', (e) => {
                e.preventDefault(); subMenuFsIsOpen = !subMenuFsIsOpen; sectionsDropdownCustomFs.setAttribute('aria-expanded', subMenuFsIsOpen.toString());
                if (subMenuFsIsOpen) { gsap.timeline().to(fsSubMenuItemsContainer, { height: 'auto', autoAlpha: 1, marginTop: '0.5rem', marginBottom: '0.5rem', duration: 0.3, ease: 'power1.out' }).to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration:0.25, stagger:0.05, ease:'power1.out' }, "-=0.2");
                } else { gsap.timeline().to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.2, stagger:{each:0.04, from:"end"}, ease:'power1.in' }).to(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0, duration: 0.3, ease: 'power1.in' }, "-=0.1");}
            });
            const fsSubMenuLinks = fsSubMenuItemsContainer ? gsap.utils.toArray(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item')) : [];
            fsSubMenuLinks.forEach(link => { link.addEventListener('mouseenter', () => gsap.to(link, { color: '#0d6efd', x: 3, duration: 0.2 })); link.addEventListener('mouseleave', () => gsap.to(link, { color: (link.classList.contains('active') ? '#0d6efd' : '#495057'), x: 0, duration: 0.2 }));});
        }
        const activeFsDropdownItem = fullscreenMenu.querySelector('.dropdown-menu-custom a.dropdown-item.active');
        if (activeFsDropdownItem) { activeFsDropdownItem.style.color = '#0d6efd'; activeFsDropdownItem.style.fontWeight = '500';}
    }
    // --- GSAP анимации появления секций ---
    gsap.utils.toArray('.content-section').forEach((section, i) => {
        gsap.to(section, {
            opacity: 1, y: 0, duration: 0.7, delay: i * 0.08,
            scrollTrigger: { trigger: section, start: 'top 85%', once: true }
        });
    });
    // Анимация карточек устойчивости
    gsap.utils.toArray('.resilience-card').forEach((card, i) => {
        gsap.to(card, {
            opacity: 1, y: 0, duration: 0.7, delay: 0.2 + i * 0.12,
            scrollTrigger: { trigger: card, start: 'top 90%', once: true },
            onStart: () => card.classList.add('active'),
            onReverseComplete: () => card.classList.remove('active')
        });
        card.addEventListener('mouseenter', () => {
            gsap.to(card, { scale: 1.04, boxShadow: '0 8px 32px rgba(255,106,0,0.18)', duration: 0.25 });
        });
        card.addEventListener('mouseleave', () => {
            gsap.to(card, { scale: 1, boxShadow: '0 4px 16px rgba(0,0,0,0.09)', duration: 0.4 });
        });
    });
    // Чек-лист: анимация отметки
    document.querySelectorAll('#crisisChecklistUl li').forEach(item => {
        item.addEventListener('click', function() {
            const wasChecked = item.classList.contains('checked');
            item.classList.toggle('checked');
            gsap.fromTo(item, {backgroundColor: wasChecked ? '#e9f5e9' : '#fff'}, {backgroundColor: wasChecked ? '#fff' : '#e9f5e9', duration: 0.3});
            gsap.fromTo(item.querySelector('.check-icon'), {color: wasChecked ? '#43a047' : '#ff9800'}, {color: wasChecked ? '#ff9800' : '#43a047', duration: 0.3});
        });
    });
    // Кейс-анализ: раскрытие с анимацией
    const caseBlock = document.getElementById('caseBlock');
    const showCaseStepsBtn = document.getElementById('showCaseStepsBtn');
    const caseSteps = document.getElementById('caseSteps');
    if (showCaseStepsBtn && caseSteps) {
        showCaseStepsBtn.addEventListener('click', function() {
            caseBlock.classList.add('active');
            gsap.to(caseSteps, {display: 'block', opacity: 1, y: 0, duration: 0.6, ease: 'power2.out'});
            showCaseStepsBtn.style.display = 'none';
        });
    }
    // Плавное появление кейса
    gsap.to(caseBlock, {opacity: 1, y: 0, duration: 0.7, delay: 0.2, scrollTrigger: { trigger: caseBlock, start: 'top 90%', once: true }});
    // Collapse для шаблона плана
    const collapseBtn = document.querySelector('.collapse-btn');
    if (collapseBtn) {
        collapseBtn.addEventListener('click', function() {
            setTimeout(() => ScrollTrigger.refresh(), 400);
        });
    }
    // --- AI feedback for crisis plan ---
    const getCrisisPlanAiFeedbackBtn = document.getElementById('getCrisisPlanAiFeedbackBtn');
    const aiCrisisPlanFeedbackContainer = document.getElementById('aiCrisisPlanFeedbackContainer');
    const aiCrisisPlanFeedbackResult = document.getElementById('aiCrisisPlanFeedbackResult');
    const crisisPlanForm = document.getElementById('crisisPlanForm');
    if(getCrisisPlanAiFeedbackBtn && aiCrisisPlanFeedbackContainer && aiCrisisPlanFeedbackResult && crisisPlanForm) {
        gsap.set(aiCrisisPlanFeedbackContainer, {display: 'none', autoAlpha:0});
        getCrisisPlanAiFeedbackBtn.addEventListener('click', async () => {
            const formData = new FormData(crisisPlanForm);
            const situation = formData.get('situation')?.trim();
            const triggers = formData.get('triggers')?.trim();
            const responsibles = formData.get('responsibles')?.trim();
            const actions = formData.get('actions')?.trim();
            const internal_comms = formData.get('internal_comms')?.trim();
            const external_comms = formData.get('external_comms')?.trim();
            const resources = formData.get('resources')?.trim();
            const lessons = formData.get('lessons')?.trim();
            if(!situation && !triggers && !responsibles && !actions && !internal_comms && !external_comms && !resources && !lessons) {
                alert('Пожалуйста, заполните хотя бы один пункт плана.');
                return;
            }
            gsap.timeline().set(aiCrisisPlanFeedbackContainer, {display: 'block'}).to(aiCrisisPlanFeedbackContainer, {autoAlpha:1, y:0, duration:0.4, ease: 'power2.out'});
            aiCrisisPlanFeedbackResult.innerHTML = '<em>🤖 ИИ анализирует ваш план...</em>';
            gsap.fromTo(aiCrisisPlanFeedbackResult, {opacity:0.5, y:5}, {opacity:1, y:0, duration:0.3});
            try {
                const userPrompt = `Пользователь НКО заполнил шаблон плана реагирования на кризисную ситуацию:\n\n` +
                    `Название кризисной ситуации: ${situation || 'Не указано'}\n` +
                    `Возможные триггеры/признаки: ${triggers || 'Не указано'}\n` +
                    `Ответственные лица: ${responsibles || 'Не указано'}\n` +
                    `Протокол немедленных действий: ${actions || 'Не указано'}\n` +
                    `Внутренние коммуникации: ${internal_comms || 'Не указано'}\n` +
                    `Внешние коммуникации: ${external_comms || 'Не указано'}\n` +
                    `Необходимые ресурсы: ${resources || 'Не указано'}\n` +
                    `Пост-кризисный анализ и уроки: ${lessons || 'Не указано'}\n\n` +
                    `Дай краткий, конструктивный и ободряющий комментарий по этому плану. Отметь сильные стороны, укажи, что можно улучшить, и предложи дополнительные меры, если это уместно. Ответ на русском. Не используй <think> теги.`;
                const response = await fetch('http://127.0.0.1:3355/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "qwen3-1.7b",
                        messages: [
                            { role: "system", content: "Ты — ИИ-эксперт по антикризисному управлению в НКО. Твоя задача — дать конструктивный и ободряющий фидбэк на предложенный план реагирования. Будь краток, дружелюбен и по существу. Не используй <think> теги. Ответ на русском." },
                            { role: "user", content: userPrompt }
                        ],
                        temperature: 0.6, max_tokens: 500, stream: false
                    })
                });
                if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
                const data = await response.json();
                let aiMessage = data.choices?.[0]?.message?.content?.trim() || "Не удалось получить комментарий от ИИ.";
                aiMessage = aiMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
                if (aiMessage.includes('<li>')) {
                    aiMessage = aiMessage.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`);
                    aiMessage = aiMessage.replace(/<\/ul>\s*<ul>/g, '');
                }
                aiMessage = aiMessage.replace(/\n/g, '<br>');
                gsap.to(aiCrisisPlanFeedbackResult, {opacity:0, y:-5, duration: 0.2, onComplete: () => {
                    aiCrisisPlanFeedbackResult.innerHTML = aiMessage;
                    gsap.to(aiCrisisPlanFeedbackResult, {opacity:1, y:0, duration: 0.4, ease: 'power2.out'});
                }});
            } catch (error) {
                console.error('AI Crisis Plan Advice Error:', error);
                gsap.to(aiCrisisPlanFeedbackResult, {opacity:0, y:-5, duration: 0.2, onComplete: () => {
                    aiCrisisPlanFeedbackResult.innerHTML = `😥 Ошибка получения совета от ИИ. <small>${error.message}</small>`;
                    gsap.to(aiCrisisPlanFeedbackResult, {opacity:1, y:0, duration: 0.4, ease: 'power2.out'});
                }});
            }
        });
    }
    // --- Интерактив: добавление пунктов в чек-лист ---
    const addChecklistItemForm = document.getElementById('addChecklistItemForm');
    const newChecklistItemInput = document.getElementById('newChecklistItemInput');
    const crisisChecklistUl = document.getElementById('crisisChecklistUl');
    if (addChecklistItemForm && newChecklistItemInput && crisisChecklistUl) {
        addChecklistItemForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const value = newChecklistItemInput.value.trim();
            if (!value) return;
            const li = document.createElement('li');
            li.innerHTML = `<span class='check-icon'>✔</span>${value}`;
            li.classList.add('user-added');
            crisisChecklistUl.appendChild(li);
            newChecklistItemInput.value = '';
            // Анимация появления
            gsap.fromTo(li, {opacity:0, y:10}, {opacity:1, y:0, duration:0.4, ease:'power2.out'});
        });
        // Удаление своего пункта по двойному клику
        crisisChecklistUl.addEventListener('dblclick', function(e) {
            const li = e.target.closest('li.user-added');
            if (li) {
                gsap.to(li, {opacity:0, y:10, duration:0.3, onComplete:()=>li.remove()});
            }
        });
    }
    // --- Экспорт результатов в PDF ---
    const exportBtn = document.getElementById('exportCrisisResultsBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit: 'pt', format: 'a4'});
            // Регистрируем Qanelas, если не зарегистрирован
            if (window.QanelasRegularFontData && window.QanelasRegularFontData.base64) {
                doc.addFileToVFS('Qanelas-Regular.ttf', window.QanelasRegularFontData.base64);
                doc.addFont('Qanelas-Regular.ttf', 'Qanelas', 'normal');
            }
            doc.setFont('Qanelas', 'normal');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 40;
            // Заголовок
            doc.setFontSize(22);
            doc.setTextColor('#ff6a00');
            doc.text('Антикризисное управление НКО', pageWidth/2, y, {align:'center'});
            y += 30;
            doc.setFontSize(14);
            doc.setTextColor('#333');
            doc.text('6.2. Чек-лист "Тревожный чемоданчик НКО"', 40, y);
            y += 18;
            // Чек-лист
            const checklistItems = Array.from(document.querySelectorAll('#crisisChecklistUl li')).map(li => {
                const text = li.textContent.trim();
                const checked = li.classList.contains('checked') ? '✔' : '✗';
                return [checked, text];
            });
            doc.autoTable({
                head: [['Статус', 'Пункт']],
                body: checklistItems,
                startY: y,
                theme: 'grid',
                headStyles: {fillColor: [255,186,73], textColor: '#333', fontStyle:'bold', font: 'Qanelas'},
                bodyStyles: {fontSize: 11, textColor: '#222', font: 'Qanelas'},
                styles: {cellPadding: 4, font: 'Qanelas'},
                margin: {left: 40, right: 40}
            });
            y = doc.lastAutoTable.finalY + 24;
            // План реагирования
            doc.setFontSize(14);
            doc.setTextColor('#333');
            doc.text('6.3. План реагирования на кризисную ситуацию', 40, y);
            y += 18;
            const planForm = document.getElementById('crisisPlanForm');
            if (planForm) {
                const formData = new FormData(planForm);
                const planFields = [
                    ['Название кризисной ситуации', formData.get('situation') || ''],
                    ['Возможные триггеры/признаки', formData.get('triggers') || ''],
                    ['Ответственные лица', formData.get('responsibles') || ''],
                    ['Протокол немедленных действий', formData.get('actions') || ''],
                    ['Внутренние коммуникации', formData.get('internal_comms') || ''],
                    ['Внешние коммуникации', formData.get('external_comms') || ''],
                    ['Необходимые ресурсы', formData.get('resources') || ''],
                    ['Пост-кризисный анализ и уроки', formData.get('lessons') || '']
                ];
                doc.autoTable({
                    head: [['Параметр', 'Ответ']],
                    body: planFields,
                    startY: y,
                    theme: 'striped',
                    headStyles: {fillColor: [255,186,73], textColor: '#333', fontStyle:'bold', font: 'Qanelas'},
                    bodyStyles: {fontSize: 11, textColor: '#222', font: 'Qanelas'},
                    styles: {cellPadding: 4, font: 'Qanelas'},
                    margin: {left: 40, right: 40}
                });
                y = doc.lastAutoTable.finalY + 24;
            }
            // AI feedback
            doc.setFontSize(14);
            doc.setTextColor('#333');
            doc.text('AI-отзыв по плану', 40, y);
            y += 18;
            const aiFeedback = document.getElementById('aiCrisisPlanFeedbackResult')?.innerText || '';
            doc.setFontSize(11);
            doc.setTextColor('#444');
            const splitFeedback = doc.splitTextToSize(aiFeedback, pageWidth-80);
            doc.text(splitFeedback, 40, y);
            // Сохранить PDF
            doc.save('crisis_management_results.pdf');
        });
    }
    ScrollTrigger.refresh();
});
</script>
</body>
</html>
