<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6. Антикризисное управление - Семинар НКО</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/animations.css">
    <style>
        body { padding-top: 70px; overflow-x: hidden; }
        .page-header-section {
            background: linear-gradient(135deg, #ff6a00 0%, #ffb347 100%);
            color: #212529;
            padding: 4rem 1.5rem; margin-bottom: 2rem; border-radius: .3rem; text-align: center;
        }
        .page-header-section img.header-icon { width: 80px; height: 80px; margin-bottom: 1rem; }
        .content-section { margin-bottom: 3rem; opacity: 0; transform: translateY(40px); }
        .content-section h3, .content-section h4 {
            margin-bottom: 1.5rem; display: flex; align-items: center;
            font-weight: 600; color: #343a40;
        }
        .content-section h3 img.section-icon, .content-section h4 img.section-icon {
            width: 32px; height: 32px; margin-right: 0.8rem; opacity: 0.8;
        }
        /* Карточки устойчивости */
        .resilience-card {
            background: #fff; border-radius: .7rem; box-shadow: 0 4px 16px rgba(0,0,0,0.09);
            padding: 2rem 1.5rem; margin-bottom: 1.5rem; transition: box-shadow 0.3s, transform 0.3s; /* Added transform */
            cursor: pointer; opacity: 0; transform: translateY(30px);
        }
        .resilience-card:hover {
            transform: translateY(-5px) scale(1.02); /* Hover effect */
            box-shadow: 0 8px 24px rgba(255,106,0,0.13);
        }
        .resilience-card .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: .5rem; }
        .resilience-card .card-icon { width: 36px; height: 36px; margin-right: .7rem; vertical-align: middle; }
        /* Чек-лист */
        .crisis-checklist { background: #fffbe6; border-radius: .6rem; padding: 2rem 1.5rem; box-shadow: 0 2px 10px rgba(255,106,0,0.07); }
        .crisis-checklist ul { list-style: none; padding-left: 0; }
        .crisis-checklist li { margin-bottom: 1.1rem; padding: .7rem 1rem; border-radius: .4rem; border: 1px solid #ffe0b2; background: #fff; cursor: pointer; display: flex; align-items: center; transition: background 0.2s, border 0.2s; }
        .crisis-checklist li.checked { background: #e9f5e9; border-color: #c3e6cb; }
        .crisis-checklist .check-icon { color: #ff9800; font-size: 1.3rem; margin-right: .7rem; transition: color 0.2s; }
        .crisis-checklist li.checked .check-icon { color: #43a047; }
        /* Шаблон плана */
        .crisis-plan-template { background: #f8f9fa; border-radius: .6rem; padding: 2rem 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); margin-bottom: 2rem; }
        .crisis-plan-template .template-row { margin-bottom: 1.2rem; }
        .crisis-plan-template label { font-weight: 500; }
        .crisis-plan-template textarea, .crisis-plan-template input { font-size: 1rem; }
        .collapse-btn { background: none; border: none; color: #ff6a00; font-weight: 600; cursor: pointer; margin-bottom: 1rem; }
        
        /* Кейс-анализ - Новый стиль */
        .case-selection-tile {
            background-color: #fff;
            border: 1px solid #ffe0b2; /* Orange-ish border */
            border-radius: .7rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            opacity: 0; /* For GSAP */
            transform: translateY(20px) scale(0.95); /* For GSAP */
        }
        .case-selection-tile:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 20px rgba(255,106,0,0.15);
            border-color: #ff9800;
        }
        .case-selection-tile.active-case-tile {
             background-color: #fffbe6; /* Light yellow/orange */
             border-color: #ffc107;
             box-shadow: 0 6px 18px rgba(255,152,0,0.2);
        }
        .case-selection-tile img.case-tile-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 1rem;
            filter: grayscale(50%) opacity(0.7);
            transition: filter 0.3s;
        }
        .case-selection-tile:hover img.case-tile-icon,
        .case-selection-tile.active-case-tile img.case-tile-icon {
             filter: grayscale(0%) opacity(1);
        }
        .case-selection-tile h5 {
            font-weight: 600;
            color: #cc5500; /* Darker orange */
            margin-bottom: 0.5rem;
        }
        #caseStudyDisplayContainer {
            margin-top: 2.5rem;
            opacity: 0; /* For GSAP */
            transform: translateY(20px); /* For GSAP */
        }
        .case-study-card-content {
            background-color: #fff;
            border-radius: .8rem;
            padding: 2rem;
            box-shadow: 0 6px 25px rgba(0,0,0,0.1);
            border-left: 7px solid #ff6a00;
        }
        .case-study-card-content h4 { color: #ff6a00; margin-bottom: 1rem; }
        .case-study-card-content p strong { color: #333; }
        .case-study-card-content ul { padding-left: 1.2rem; }
        .case-study-card-content ul li { margin-bottom: 0.5rem; }
        .case-study-card-content .crisis-outcome {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px dashed #ffb347;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="../index.html">
                <img src="../assets/images/logo.svg" alt="Лого НКО">
                Семинар НКО
            </a>
            <button class="navbar-custom-toggler ms-auto" aria-label="Открыть меню" id="customMenuToggler" aria-expanded="false">
                <svg viewBox="0 0 100 80" width="30" height="30" id="actualBurgerIcon" fill="currentColor">
                    <rect class="line line1" x="0" y="10" width="100" height="10" rx="5"></rect>
                    <rect class="line line2" x="0" y="35" width="100" height="10" rx="5"></rect>
                    <rect class="line line3" x="0" y="60" width="100" height="10" rx="5"></rect>
                </svg>
            </button>
        </div>
    </nav>
</header>
<div class="fullscreen-menu" id="fullscreenMenu">
    <button class="close-menu-btn" id="closeFullscreenMenu" aria-label="Закрыть меню">×</button>
    <ul class="navbar-nav-fullscreen">
        <li class="nav-item fs-menu-item"><a class="nav-link" href="../index.html">Главная</a></li>
        <li class="nav-item fs-menu-item custom-dropdown">
            <a class="nav-link dropdown-toggle-custom active" href="#" id="sectionsDropdownCustomFs" role="button" aria-expanded="false">Разделы</a>
            <ul class="dropdown-menu-custom">
                <li><a class="dropdown-item" href="0_introduction.html">0. Введение</a></li>
                <li><a class="dropdown-item" href="1_community_building.html">1. Сообщество</a></li>
                <li><a class="dropdown-item" href="2_internal_communications.html">2. Коммуникации</a></li>
                <li><a class="dropdown-item" href="3_infrastructure.html">3. Инфраструктура</a></li>
                <li><a class="dropdown-item" href="4_legal_and_security.html">4. Безопасность</a></li>
                <li><a class="dropdown-item" href="5_effectiveness_and_development.html">5. Эффективность</a></li>
                <li><a class="dropdown-item active" href="6_crisis_management.html">6. Антикризис</a></li>
                <li><a class="dropdown-item" href="7_cases_and_practice.html">7. Практика</a></li>
            </ul>
        </li>
        <li class="nav-item fs-menu-item"><a class="nav-link" href="useful_resources.html">Полезные ресурсы</a></li>
    </ul>
</div>
<main>
    <div class="page-header-section">
        <img src="../assets/icons/crisis.svg" alt="Антикризисное управление" class="header-icon">
        <h1 class="display-5 fw-bold">Раздел 6: Антикризисное управление</h1>
        <p class="lead">Готовимся к неожиданностям: устойчивость, быстрый ответ и разбор реальных кейсов для НКО.</p>
    </div>
    <div class="container py-4">
        <!-- 6.1. Опоры устойчивости -->
        <section class="content-section" id="s6-1">
            <h3><img src="../assets/icons/community.svg" alt="Опоры устойчивости" class="section-icon">6.1. НКО в Кризис: Опоры Устойчивости</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Сообщество">
                        <span class="card-title"><img src="../assets/icons/groups.svg" class="card-icon">Сообщество</span>
                        <div class="card-text">Сильное ядро сторонников и волонтеров помогает быстро мобилизоваться, делиться ресурсами и поддерживать друг друга в трудные времена.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Коммуникации">
                        <span class="card-title"><img src="../assets/icons/communication.svg" class="card-icon">Коммуникации</span>
                        <div class="card-text">Налаженные внутренние и внешние коммуникации позволяют быстро реагировать, информировать команду и партнеров, предотвращать панику.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Инфраструктура">
                        <span class="card-title"><img src="../assets/icons/Infrastructure.svg" class="card-icon">Инфраструктура</span>
                        <div class="card-text">Резервные каналы связи, бэкапы данных, защищённые облачные сервисы и альтернативные инструменты обеспечивают непрерывность работы.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="resilience-card" data-title="Безопасность">
                        <span class="card-title"><img src="../assets/icons/safety.svg" class="card-icon">Безопасность</span>
                        <div class="card-text">Юридическая, информационная и психологическая безопасность — залог устойчивости. Важно заранее знать, куда обращаться и что делать.</div>
                    </div>
                </div>
            </div>
        </section>
        <!-- 6.2. Чек-лист "Тревожный чемоданчик НКО" -->
        <section class="content-section" id="s6-2">
            <h3><img src="../assets/icons/warning.svg" alt="Чек-лист" class="section-icon">6.2. Чек-лист "Тревожный чемоданчик НКО"</h3>
            <div class="crisis-checklist">
                <ul id="crisisChecklistUl">
                    <li><span class="check-icon">✔</span><b>Юридический:</b> Контакты адвокатов, копии уставных документов (в облаке), шаблоны заявлений</li>
                    <li><span class="check-icon">✔</span><b>Информационный:</b> Резервные каналы связи, бэкапы данных, план коммуникаций в кризис</li>
                    <li><span class="check-icon">✔</span><b>Финансовый:</b> Резервный фонд, альтернативные способы получения/распределения средств</li>
                    <li><span class="check-icon">✔</span><b>Психологический:</b> Контакты психологов, памятка по самопомощи</li>
                </ul>
                <form id="addChecklistItemForm" class="d-flex gap-2 mt-3" autocomplete="off" onsubmit="return false;">
                    <input type="text" class="form-control" id="newChecklistItemInput" placeholder="Добавить свой пункт...">
                    <button type="submit" class="btn btn-outline-warning">Добавить</button>
                </form>
                <div class="mt-2 text-muted" style="font-size:0.97rem;">Кликните по пункту для отметки готовности. Двойной клик по своему пункту — удалить.</div>
            </div>
        </section>
        <!-- 6.3. Шаблон плана реагирования -->
        <section class="content-section" id="s6-3">
            <h3><img src="../assets/icons/practical.svg" alt="План реагирования" class="section-icon">6.3. Шаблон "План реагирования на кризисную ситуацию"</h3>
            <button class="collapse-btn" type="button" data-bs-toggle="collapse" data-bs-target="#crisisPlanCollapse" aria-expanded="true">Скрыть/показать шаблон</button>
            <div class="collapse show crisis-plan-template" id="crisisPlanCollapse">
                <form id="crisisPlanForm">
                    <div class="template-row mb-3"><label>Название кризисной ситуации:</label><input type="text" class="form-control" name="situation" placeholder="Например, 'Блокировка счета'"></div>
                    <div class="template-row mb-3"><label>Возможные триггеры/признаки:</label><textarea class="form-control" name="triggers" rows="2"></textarea></div>
                    <div class="template-row mb-3"><label>Ответственные лица (основной, заместитель):</label><input type="text" class="form-control" name="responsibles" placeholder="ФИО, контакты"></div>
                    <div class="template-row mb-3"><label>Протокол немедленных действий:</label><textarea class="form-control" name="actions" rows="2" placeholder="Шаг 1, 2, 3..."></textarea></div>
                    <div class="template-row mb-3"><label>Внутренние коммуникации:</label><textarea class="form-control" name="internal_comms" rows="2" placeholder="Кого, как, о чем информировать"></textarea></div>
                    <div class="template-row mb-3"><label>Внешние коммуникации:</label><textarea class="form-control" name="external_comms" rows="2" placeholder="Целевая аудитория, ключевое сообщение, каналы, спикер"></textarea></div>
                    <div class="template-row mb-3"><label>Необходимые ресурсы:</label><textarea class="form-control" name="resources" rows="2" placeholder="Контакты, документы, финансы"></textarea></div>
                    <div class="template-row mb-3"><label>Пост-кризисный анализ и уроки:</label><textarea class="form-control" name="lessons" rows="2" placeholder="Что улучшить на будущее"></textarea></div>
                    <button type="button" class="btn btn-warning text-dark mt-2" id="getCrisisPlanAiFeedbackBtn">Получить обратную связь от ИИ</button>
                </form>
                <div id="aiCrisisPlanFeedbackContainer" class="mt-4" style="display:none;">
                    <h5 class="text-primary">Комментарий от ИИ по вашему плану:</h5>
                    <div id="aiCrisisPlanFeedbackResult" class="p-3 border rounded bg-light-subtle text-muted"><em>Заполните шаблон и нажмите кнопку...</em></div>
                </div>
            </div>
        </section>
        
        <!-- 6.4. Интерактив: Разбор кейса - НОВЫЙ БЛОК -->
        <section class="content-section" id="s6-4">
            <h3><img src="../assets/icons/cases.svg" alt="Кейс" class="section-icon">6.4. Разбор реальных кейсов: Учимся на опыте</h3>
            <p>Выберите тип кризисной ситуации, чтобы ознакомиться с примером того, как НКО справлялись с подобными вызовами. Эти кейсы основаны на реальном опыте, но могут быть обобщены для иллюстрации.</p>
            <div class="row mt-4" id="caseSelectionContainer">
                <div class="col-md-4 mb-3">
                    <div class="case-selection-tile" data-case-id="financialBlock">
                        <img src="../assets/icons/paid.svg" alt="Финансовая блокада" class="case-tile-icon">
                        <h5>Финансовая блокада</h5>
                        <p class="small text-muted">Потеря финансирования, блокировка счетов.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="case-selection-tile" data-case-id="legalPressure">
                        <img src="../assets/icons/rights.svg" alt="Юридическое давление" class="case-tile-icon">
                        <h5>Юридическое давление</h5>
                        <p class="small text-muted">Проверки, обыски, судебные иски.</p>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="case-selection-tile" data-case-id="digitalAttack">
                        <img src="../assets/icons/safety.svg" alt="Цифровая атака" class="case-tile-icon">
                        <h5>Цифровые атаки</h5>
                        <p class="small text-muted">DDoS, взломы, дискредитация онлайн.</p>
                    </div>
                </div>
            </div>
            <div id="caseStudyDisplayContainer" style="display: none;">
                <div class="case-study-card-content">
                    <h4 id="caseStudyTitle"></h4>
                    <p><strong>Краткое описание кризиса:</strong> <span id="caseStudyCrisisDesc"></span></p>
                    <p><strong>Действия НКО:</strong></p>
                    <ul id="caseStudyActionsList"></ul>
                    <p class="crisis-outcome"><strong>Результат/Уроки:</strong> <span id="caseStudyOutcome"></span></p>
                </div>
            </div>
        </section>
    </div>
</main>
<footer class="py-4 bg-dark text-white-50 mt-5">
    <div class="container text-center">
        <small>Материалы семинара © 2024.</small> <br>
        <small><em>Информация на сайте носит ознакомительный характер и не является юридической консультацией. Для принятия решений всегда обращайтесь к квалифицированным специалистам.</em></small>
        <div class="mt-4">
            <button class="btn btn-success" id="exportCrisisResultsBtn">Выгрузить результаты раздела</button>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script>
<script src="../assets/fonts/Qanelas-Regular.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
const GOOGLE_AI_API_KEY = "AIzaSyDl6bLHj4tFonVVBnKDhgIpdrTQuZXmhqo";
const GOOGLE_AI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/";
const GOOGLE_AI_MODEL = "gemma-3n-e4b-it"; 
const GOOGLE_AI_API_URL = `${GOOGLE_AI_API_URL_BASE}${GOOGLE_AI_MODEL}:generateContent?key=${GOOGLE_AI_API_KEY}`;

document.addEventListener('DOMContentLoaded', () => {
    gsap.registerPlugin(ScrollTrigger);
    // --- Меню (аналогично другим страницам) ---
    const customMenuToggler = document.getElementById('customMenuToggler');
    const fullscreenMenu = document.getElementById('fullscreenMenu');
    const closeFullscreenMenuBtn = document.getElementById('closeFullscreenMenu');
    if (customMenuToggler && fullscreenMenu) { /* ... (полный код меню) ... */ 
        const fsNav = fullscreenMenu.querySelector('.navbar-nav-fullscreen');
        const fsMenuItems = fsNav ? gsap.utils.toArray(fsNav.querySelectorAll('.fs-menu-item > a, .fs-menu-item > .dropdown-toggle-custom')) : [];
        const fsSubMenuItemsContainer = fsNav ? fsNav.querySelector('.fs-menu-item.custom-dropdown .dropdown-menu-custom') : null;
        const actualBurgerIcon = customMenuToggler.querySelector('svg');
        const burgerLine1 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line1') : null;
        const burgerLine2 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line2') : null;
        const burgerLine3 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line3') : null;
        let burgerTimeline = gsap.timeline({ paused: true, reversed: true });
        if (burgerLine1 && burgerLine2 && burgerLine3) {
            const line1YInitial = parseFloat(burgerLine1.getAttribute('y'));
            const line2YInitial = parseFloat(burgerLine2.getAttribute('y'));
            const line3YInitial = parseFloat(burgerLine3.getAttribute('y'));
            if (!isNaN(line1YInitial) && !isNaN(line2YInitial) && !isNaN(line3YInitial)) {
                burgerTimeline.to(burgerLine1,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross").to(burgerLine3,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross").to(burgerLine2,{duration:0.2,scaleX:0,transformOrigin:"50% 50%",ease:"power2.in"},"cross").to(burgerLine1,{duration:0.25,rotation:45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd").to(burgerLine3,{duration:0.25,rotation:-45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd");
            } else { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
        } else if (actualBurgerIcon) { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
        let fsMenuIsOpen = false;
        gsap.set(fullscreenMenu, { display: 'none', autoAlpha: 0 }); 
        if (fsMenuItems.length > 0) gsap.set(fsMenuItems, { autoAlpha: 0, y: 20 });
        if (fsSubMenuItemsContainer) gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
        const openFullscreenMenu = () => { if (fsMenuIsOpen) return; fsMenuIsOpen = true; fullscreenMenu.style.display = 'flex'; burgerTimeline.play(); customMenuToggler.classList.add('open'); customMenuToggler.setAttribute('aria-expanded', 'true'); const tlOpen = gsap.timeline(); tlOpen.to(fullscreenMenu, { autoAlpha: 1, duration: 0.35, ease: 'power1.out' }); if (fsMenuItems.length > 0) tlOpen.to(fsMenuItems, { autoAlpha: 1, y: 0, duration: 0.3, stagger: 0.06, ease: 'power1.out' }, "-=0.2"); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if (sectionsDropdownCustomFs && sectionsDropdownCustomFs.classList.contains('active') && fsSubMenuItemsContainer) { if (sectionsDropdownCustomFs.getAttribute('aria-expanded') === 'true' || fsSubMenuItemsContainer.style.height === 'auto') { tlOpen.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration: 0.2, stagger: 0.04, ease: 'power1.out' }, "-=0.1"); }}};
        const closeFullscreenMenu = () => { if (!fsMenuIsOpen) return; fsMenuIsOpen = false; burgerTimeline.reverse(); customMenuToggler.classList.remove('open'); customMenuToggler.setAttribute('aria-expanded', 'false'); const tlClose = gsap.timeline({onComplete: () => { fullscreenMenu.style.display = 'none'; if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10}); gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0}); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if(sectionsDropdownCustomFs) sectionsDropdownCustomFs.setAttribute('aria-expanded', 'false');}}}); if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { tlClose.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.15, stagger: {each:0.03, from:"end"}, ease:'power1.in' });} if (fsMenuItems.length > 0) tlClose.to(fsMenuItems, { autoAlpha: 0, y: 15, duration: 0.2, stagger: { each: 0.04, from: "end" }, ease: 'power1.in' }, fsSubMenuItemsContainer ? "-=0.1" : 0); tlClose.to(fullscreenMenu, { autoAlpha: 0, duration: 0.25, ease: 'power1.in' }, fsMenuItems.length > 0 ? "-=0.1" : 0); };
        customMenuToggler.addEventListener('click', () => { fsMenuIsOpen ? closeFullscreenMenu() : openFullscreenMenu(); });
        if (closeFullscreenMenuBtn) closeFullscreenMenuBtn.addEventListener('click', closeFullscreenMenu);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && fsMenuIsOpen) closeFullscreenMenu(); });
        const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs');
        if (sectionsDropdownCustomFs && fsSubMenuItemsContainer) {
            gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop:0, marginBottom:0 }); gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
            let subMenuFsIsOpen = false;
            sectionsDropdownCustomFs.addEventListener('click', (e) => {
                e.preventDefault(); subMenuFsIsOpen = !subMenuFsIsOpen; sectionsDropdownCustomFs.setAttribute('aria-expanded', subMenuFsIsOpen.toString());
                if (subMenuFsIsOpen) { gsap.timeline().to(fsSubMenuItemsContainer, { height: 'auto', autoAlpha: 1, marginTop: '0.5rem', marginBottom: '0.5rem', duration: 0.3, ease: 'power1.out' }).to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration:0.25, stagger:0.05, ease:'power1.out' }, "-=0.2");
                } else { gsap.timeline().to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.2, stagger:{each:0.04, from:"end"}, ease:'power1.in' }).to(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0, duration: 0.3, ease: 'power1.in' }, "-=0.1");}
            });
            const fsSubMenuLinks = fsSubMenuItemsContainer ? gsap.utils.toArray(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item')) : [];
            fsSubMenuLinks.forEach(link => { link.addEventListener('mouseenter', () => gsap.to(link, { color: '#0d6efd', x: 3, duration: 0.2 })); link.addEventListener('mouseleave', () => gsap.to(link, { color: (link.classList.contains('active') ? '#0d6efd' : '#495057'), x: 0, duration: 0.2 }));});
        }
        const activeFsDropdownItem = fullscreenMenu.querySelector('.dropdown-menu-custom a.dropdown-item.active');
        if (activeFsDropdownItem) { activeFsDropdownItem.style.color = '#0d6efd'; activeFsDropdownItem.style.fontWeight = '500';}
    }
    // --- GSAP анимации появления секций ---
    gsap.utils.toArray('.content-section').forEach((section, i) => {
        gsap.to(section, {
            opacity: 1, y: 0, duration: 0.7, delay: i * 0.08,
            scrollTrigger: { trigger: section, start: 'top 85%', once: true }
        });
    });
    // Анимация карточек устойчивости
    gsap.utils.toArray('.resilience-card').forEach((card, i) => {
        gsap.to(card, {
            opacity: 1, y: 0, duration: 0.7, delay: 0.2 + i * 0.12,
            scrollTrigger: { trigger: card, start: 'top 90%', once: true }
        });
        card.addEventListener('mouseenter', () => gsap.to(card, { scale: 1.04, boxShadow: '0 8px 32px rgba(255,106,0,0.18)', duration: 0.25 }));
        card.addEventListener('mouseleave', () => gsap.to(card, { scale: 1, boxShadow: '0 4px 16px rgba(0,0,0,0.09)', duration: 0.4 }));
    });
    // Чек-лист: анимация отметки и добавление/удаление
    const crisisChecklistUl = document.getElementById('crisisChecklistUl');
    if (crisisChecklistUl) {
        crisisChecklistUl.addEventListener('click', function(e) {
            const item = e.target.closest('li');
            if (!item) return;
            const wasChecked = item.classList.contains('checked');
            item.classList.toggle('checked');
            gsap.fromTo(item, {backgroundColor: wasChecked ? '#e9f5e9' : '#fff'}, {backgroundColor: wasChecked ? '#fff' : '#e9f5e9', duration: 0.3});
            gsap.fromTo(item.querySelector('.check-icon'), {color: wasChecked ? '#43a047' : '#ff9800'}, {color: wasChecked ? '#ff9800' : '#43a047', duration: 0.3});
        });
        const addChecklistItemForm = document.getElementById('addChecklistItemForm');
        const newChecklistItemInput = document.getElementById('newChecklistItemInput');
        addChecklistItemForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const value = newChecklistItemInput.value.trim();
            if (!value) return;
            const li = document.createElement('li');
            li.innerHTML = `<span class='check-icon'>✔</span>${value}`;
            li.classList.add('user-added');
            crisisChecklistUl.appendChild(li);
            newChecklistItemInput.value = '';
            gsap.fromTo(li, {opacity:0, y:10}, {opacity:1, y:0, duration:0.4, ease:'power2.out'});
        });
        crisisChecklistUl.addEventListener('dblclick', function(e) {
            const li = e.target.closest('li.user-added');
            if (li) {
                gsap.to(li, {opacity:0, y:10, duration:0.3, onComplete:()=>li.remove()});
            }
        });
    }
    // Collapse для шаблона плана
    const crisisPlanCollapseEl = document.getElementById('crisisPlanCollapse');
    if (crisisPlanCollapseEl) {
        crisisPlanCollapseEl.addEventListener('shown.bs.collapse', () => ScrollTrigger.refresh());
        crisisPlanCollapseEl.addEventListener('hidden.bs.collapse', () => ScrollTrigger.refresh());
    }
    
    // --- AI feedback for crisis plan ---
    const getCrisisPlanAiFeedbackBtn = document.getElementById('getCrisisPlanAiFeedbackBtn');
    const aiCrisisPlanFeedbackContainer = document.getElementById('aiCrisisPlanFeedbackContainer');
    const aiCrisisPlanFeedbackResult = document.getElementById('aiCrisisPlanFeedbackResult');
    const crisisPlanForm = document.getElementById('crisisPlanForm');

    if(getCrisisPlanAiFeedbackBtn && aiCrisisPlanFeedbackContainer && aiCrisisPlanFeedbackResult && crisisPlanForm) {
        gsap.set(aiCrisisPlanFeedbackContainer, {display: 'none', autoAlpha:0});
        getCrisisPlanAiFeedbackBtn.addEventListener('click', async () => {
            const formData = new FormData(crisisPlanForm);
            const situation = formData.get('situation')?.trim();
            const triggers = formData.get('triggers')?.trim();
            const responsibles = formData.get('responsibles')?.trim();
            const actions = formData.get('actions')?.trim();
            const internal_comms = formData.get('internal_comms')?.trim();
            const external_comms = formData.get('external_comms')?.trim();
            const resources = formData.get('resources')?.trim();
            const lessons = formData.get('lessons')?.trim();
            if(!situation && !triggers && !responsibles && !actions && !internal_comms && !external_comms && !resources && !lessons) {
                alert('Пожалуйста, заполните хотя бы один пункт плана.'); return;
            }
            gsap.timeline().set(aiCrisisPlanFeedbackContainer, {display: 'block'}).to(aiCrisisPlanFeedbackContainer, {autoAlpha:1, y:0, duration:0.4, ease: 'power2.out'});
            aiCrisisPlanFeedbackResult.innerHTML = '<em>🤖 ИИ анализирует ваш план...</em>';
            gsap.fromTo(aiCrisisPlanFeedbackResult, {opacity:0.5, y:5}, {opacity:1, y:0, duration:0.3});
            try {
                const systemPromptText = "Ты — ИИ-эксперт по антикризисному управлению в НКО. Твоя задача — дать конструктивный и краткий фидбэк на предложенный план реагирования. Отметь сильные стороны, укажи, что можно улучшить. Будь краток. Ответ на русском.";
                const userDataText = `Пользователь НКО заполнил шаблон плана реагирования на кризисную ситуацию:\n\n` +
                    `Название кризисной ситуации: ${situation || 'Не указано'}\n` +
                    `Возможные триггеры/признаки: ${triggers || 'Не указано'}\n` +
                    `Ответственные лица: ${responsibles || 'Не указано'}\n` +
                    `Протокол немедленных действий: ${actions || 'Не указано'}\n` +
                    `Внутренние коммуникации: ${internal_comms || 'Не указано'}\n` +
                    `Внешние коммуникации: ${external_comms || 'Не указано'}\n` +
                    `Необходимые ресурсы: ${resources || 'Не указано'}\n` +
                    `Пост-кризисный анализ и уроки: ${lessons || 'Не указано'}`;
                const combinedUserPrompt = `${systemPromptText}\n\n### План пользователя:\n${userDataText}\n\n### Твой фидбэк:`;
                
                const requestPayload = {
                    contents: [{ role: "user", parts: [{ "text": combinedUserPrompt }] }],
                    generationConfig: { temperature: 0.6, maxOutputTokens: 800 }
                };

                const response = await fetch(GOOGLE_AI_API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: 'Unknown API error format' } }));
                    console.error("Google AI API Error (Crisis Plan):", errorData);
                    throw new Error(`Ошибка сети: ${response.status} - ${errorData.error?.message || response.statusText}`);
                }
                const data = await response.json();
                let aiMessage = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Не удалось получить комментарий от ИИ.";
                aiMessage = aiMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
                if (aiMessage.includes('<li>')) { aiMessage = aiMessage.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); aiMessage = aiMessage.replace(/<\/ul>\s*<ul>/g, ''); }
                aiMessage = aiMessage.replace(/\n/g, '<br>');
                gsap.to(aiCrisisPlanFeedbackResult, {opacity:0, y:-5, duration: 0.2, onComplete: () => {
                    aiCrisisPlanFeedbackResult.innerHTML = aiMessage;
                    gsap.to(aiCrisisPlanFeedbackResult, {opacity:1, y:0, duration: 0.4, ease: 'power2.out'});
                }});
            } catch (error) {
                console.error('AI Crisis Plan Advice Error:', error);
                gsap.to(aiCrisisPlanFeedbackResult, {opacity:0, y:-5, duration: 0.2, onComplete: () => {
                    aiCrisisPlanFeedbackResult.innerHTML = `😥 Ошибка получения совета от ИИ. <small>${error.message}</small>`;
                    gsap.to(aiCrisisPlanFeedbackResult, {opacity:1, y:0, duration: 0.4, ease: 'power2.out'});
                }});
            }
        });
    }

    // --- 6.4. Интерактив: Разбор кейса - НОВЫЙ КОД ---
    const caseTiles = gsap.utils.toArray('.case-selection-tile');
    const caseStudyDisplayContainer = document.getElementById('caseStudyDisplayContainer');
    const caseStudyTitleEl = document.getElementById('caseStudyTitle');
    const caseStudyCrisisDescEl = document.getElementById('caseStudyCrisisDesc');
    const caseStudyActionsListEl = document.getElementById('caseStudyActionsList');
    const caseStudyOutcomeEl = document.getElementById('caseStudyOutcome');

    const caseStudiesData = {
        financialBlock: {
            title: "Кейс: Финансовая блокада НКО «Мост Содействия»",
            crisisDesc: "Внезапное прекращение основного грантового финансирования и одновременная заморозка банковского счета по формальным причинам, что парализовало выплаты зарплат и операционные расходы.",
            actions: [
                "Экстренное оповещение ключевой команды и правления, формирование антикризисного штаба.",
                "Немедленное обращение к юристам для оспаривания заморозки счета и анализа правовых рисков.",
                "Запуск публичной фандрайзинговой кампании с упором на малые регулярные пожертвования от граждан, объяснение ситуации и важности работы НКО.",
                "Радикальное сокращение всех несущественных расходов, временный переход части сотрудников на неполный рабочий день (с их согласия).",
                "Обращение к партнерским организациям и лояльным донорам за экстренной поддержкой.",
                "Активизация волонтерского ресурса для помощи в текущей деятельности и фандрайзинге.",
                "Разработка долгосрочной стратегии диверсификации источников финансирования."
            ],
            outcome: "Удалось собрать значительную сумму через краудфандинг, что позволило покрыть критические расходы. Через несколько месяцев судебных разбирательств часть средств на счете была разморожена. НКО пересмотрела финансовую модель, увеличив долю частных пожертвований и начав поиск новых грантовых возможностей от различных фондов."
        },
        legalPressure: {
            title: "Кейс: Юридическое давление на НКО «Голос за Справедливость»",
            crisisDesc: "Серия внеплановых проверок со стороны различных контролирующих органов (Минюст, прокуратура, налоговая), инициированных по анонимным жалобам. Обыск в офисе с изъятием техники и документов. Публичная дискредитационная кампания в про-государственных СМИ.",
            actions: [
                "Активация протокола безопасности при обыске: немедленный вызов адвокатов, фиксация всех действий проверяющих (если возможно), информирование партнерских правозащитных организаций.",
                "Обеспечение сохранности резервных копий данных на защищенных внешних носителях и в облаке (вне офиса).",
                "Переход на защищенные каналы внутренней коммуникации.",
                "Оперативная публикация официального заявления о проверках и обыске, опровержение ложной информации из СМИ, поддержание связи с лояльными журналистами.",
                "Мобилизация сообщества для общественной поддержки: письма в поддержку, освещение ситуации в соцсетях.",
                "Оказание юридической и психологической помощи сотрудникам, пострадавшим от давления.",
                "Подготовка к возможным судебным разбирательствам, поиск дополнительных юридических ресурсов."
            ],
            outcome: "Несмотря на изъятие части оборудования, НКО смогла частично продолжить работу удаленно. Широкая общественная и международная огласка помогла снизить интенсивность прямого давления. Организация усилила меры безопасности и юридическую подготовку. Часть сотрудников прошла тренинги по поведению во время обысков и допросов."
        },
        digitalAttack: {
            title: "Кейс: Цифровая атака на НКО в изгнании «ИнфоЩит»",
            crisisDesc: "Массированная DDoS-атака на основной сайт организации, приводящая к его полной недоступности. Одновременный взлом аккаунтов в социальных сетях и публикация от имени НКО фейковых новостей и дискредитирующих материалов, нацеленных на аудиторию в стране происхождения.",
            actions: [
                "Немедленное обращение к хостинг-провайдеру и специалистам по кибербезопасности для смягчения DDoS-атаки и восстановления доступа к сайту.",
                "Публикация сообщений о взломе через резервные каналы связи и аккаунты дружественных организаций/активистов.",
                "Срочная смена паролей на всех аккаунтах организации и сотрудников, внедрение обязательной двухфакторной аутентификации повсеместно.",
                "Проведение полного аудита безопасности всех цифровых активов, выявление уязвимостей.",
                "Активное опровержение дезинформации, опубликованной с взломанных аккаunтов, предоставление фактов.",
                "Информирование доноров и партнеров о ситуации и принимаемых мерах.",
                "Усиление обучения сотрудников основам цифровой гигиены и безопасности."
            ],
            outcome: "Доступ к сайту был восстановлен в течение суток, контроль над соцсетями – в течение нескольких дней. Инцидент повысил осведомленность сообщества о цифровых угрозах. НКО значительно улучшила свои протоколы кибербезопасности и разработала план быстрого реагирования на подобные атаки."
        }
    };

    if (caseTiles.length > 0 && caseStudyDisplayContainer) {
        gsap.utils.toArray('#caseSelectionContainer .case-selection-tile').forEach((tile, i) => {
            gsap.to(tile, { opacity: 1, y: 0, scale: 1, duration: 0.6, delay: 0.3 + i * 0.15, scrollTrigger: { trigger: tile, start: "top 90%", once: true }});
        });

        caseTiles.forEach(tile => {
            tile.addEventListener('click', function() {
                const caseId = this.dataset.caseId;
                const caseData = caseStudiesData[caseId];

                if (caseData) {
                    // Снять активность с других плиток
                    caseTiles.forEach(t => t.classList.remove('active-case-tile'));
                    this.classList.add('active-case-tile'); // Подсветить выбранную плитку

                    caseStudyTitleEl.textContent = caseData.title;
                    caseStudyCrisisDescEl.textContent = caseData.crisisDesc;
                    caseStudyActionsListEl.innerHTML = caseData.actions.map(action => `<li>${action}</li>`).join('');
                    caseStudyOutcomeEl.textContent = caseData.outcome;
                    
                    gsap.set(caseStudyDisplayContainer, {display: 'block'});
                    gsap.to(caseStudyDisplayContainer, {opacity: 1, y: 0, duration: 0.5, ease: 'power2.out'});
                    caseStudyDisplayContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        });
    }


    // --- Экспорт результатов в PDF ---
    const exportBtn = document.getElementById('exportCrisisResultsBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({unit: 'pt', format: 'a4'});
            if (window.QanelasRegularFontData && window.QanelasRegularFontData.base64) {
                doc.addFileToVFS('Qanelas-Regular.ttf', window.QanelasRegularFontData.base64);
                doc.addFont('Qanelas-Regular.ttf', 'Qanelas', 'normal');
            }
            doc.setFont('Qanelas', 'normal');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 40;
            doc.setFontSize(22); doc.setTextColor('#ff6a00'); doc.text('Антикризисное управление НКО', pageWidth/2, y, {align:'center'}); y += 30;
            
            // Чек-лист
            doc.setFontSize(14); doc.setTextColor('#333'); doc.text('6.2. Чек-лист "Тревожный чемоданчик НКО"', 40, y); y += 18;
            const checklistItems = Array.from(document.querySelectorAll('#crisisChecklistUl li')).map(li => {
                const text = li.textContent.trim().replace(/^✔\s*/, ''); // Убираем галочку из текста
                const checked = li.classList.contains('checked') ? 'Готово ✔' : 'Не готово ✗';
                return [checked, text];
            });
            doc.autoTable({
                head: [['Статус', 'Пункт']], body: checklistItems, startY: y, theme: 'grid',
                headStyles: {fillColor: [255,186,73], textColor: '#333', fontStyle:'bold', font: 'Qanelas'},
                bodyStyles: {fontSize: 10, textColor: '#222', font: 'Qanelas'}, styles: {cellPadding: 4, font: 'Qanelas'},
                margin: {left: 40, right: 40}
            });
            y = doc.lastAutoTable.finalY + 24;
            if (y > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); y = 40; }

            // План реагирования
            doc.setFontSize(14); doc.setTextColor('#333'); doc.text('6.3. План реагирования на кризисную ситуацию', 40, y); y += 18;
            if (crisisPlanForm) {
                const formData = new FormData(crisisPlanForm);
                const planFields = [
                    ['Название ситуации', formData.get('situation') || ''], ['Триггеры', formData.get('triggers') || ''],
                    ['Ответственные', formData.get('responsibles') || ''], ['Действия', formData.get('actions') || ''],
                    ['Внутр. коммуникации', formData.get('internal_comms') || ''], ['Внешн. коммуникации', formData.get('external_comms') || ''],
                    ['Ресурсы', formData.get('resources') || ''], ['Уроки', formData.get('lessons') || '']
                ].filter(field => field[1].trim() !== ''); // Только заполненные
                if (planFields.length > 0) {
                    doc.autoTable({
                        head: [['Параметр', 'Ответ']], body: planFields, startY: y, theme: 'striped',
                        headStyles: {fillColor: [255,186,73], textColor: '#333', fontStyle:'bold', font: 'Qanelas'},
                        bodyStyles: {fontSize: 10, textColor: '#222', font: 'Qanelas'}, styles: {cellPadding: 4, font: 'Qanelas'},
                        margin: {left: 40, right: 40}
                    });
                    y = doc.lastAutoTable.finalY + 15;
                } else { doc.setFontSize(10); doc.setTextColor('#555'); doc.text('Шаблон плана не заполнен.', 45, y); y+=15;}
            }
            if (y > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); y = 40; }
            
            // AI feedback по плану
            const aiFeedbackText = aiCrisisPlanFeedbackResult?.innerText || '';
            if (aiCrisisPlanFeedbackResult && aiFeedbackText.trim() && !aiFeedbackText.includes('Заполните шаблон')) {
                doc.setFontSize(12); doc.setTextColor('#ff6a00'); doc.text('Комментарий ИИ по плану:', 40, y); y += 15;
                doc.setFontSize(10); doc.setTextColor('#444');
                const splitFeedback = doc.splitTextToSize(aiFeedbackText, pageWidth-80);
                doc.text(splitFeedback, 40, y);
                y += splitFeedback.length * 12 + 15;
                if (y > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); y = 40; }
            }
            
            // Выбранный кейс
            const activeCaseTile = document.querySelector('.case-selection-tile.active-case-tile');
            if(activeCaseTile && caseStudyDisplayContainer.style.display !== 'none'){
                doc.setFontSize(14); doc.setTextColor('#333'); doc.text('6.4. Разбор выбранного кейса', 40, y); y += 18;
                doc.setFontSize(12); doc.setTextColor('#ff6a00'); doc.text(caseStudyTitleEl.textContent, 40, y); y +=15;
                doc.setFontSize(10); doc.setTextColor('#444');
                doc.text("Описание кризиса:", 40, y); y +=12;
                const descSplit = doc.splitTextToSize(caseStudyCrisisDescEl.textContent, pageWidth - 80);
                doc.text(descSplit, 45, y); y += descSplit.length * 12 + 8;

                doc.text("Действия НКО:", 40, y); y +=12;
                const actionsItems = Array.from(caseStudyActionsListEl.querySelectorAll('li')).map(li => `• ${li.textContent}`);
                actionsItems.forEach(actionText => {
                    const actionSplit = doc.splitTextToSize(actionText, pageWidth - 90);
                    doc.text(actionSplit, 45, y); y += actionSplit.length * 12 + 3;
                     if (y > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); y = 40; }
                });
                y += 5;
                doc.text("Результат/Уроки:", 40, y); y +=12;
                const outcomeSplit = doc.splitTextToSize(caseStudyOutcomeEl.textContent, pageWidth - 80);
                doc.text(outcomeSplit, 45, y); y += outcomeSplit.length * 12 + 8;
                if (y > doc.internal.pageSize.getHeight() - 60) { doc.addPage(); y = 40; }
            }

            doc.save('crisis_management_results.pdf');
        });
    }
    ScrollTrigger.refresh();
});
</script>
</body>
</html>