<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5. Эффективность и Развитие - Семинар НКО</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body { padding-top: 70px; overflow-x: hidden; }
        .page-header-section {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); /* Желто-оранжевый градиент */
            color: #212529; /* Темный текст на светлом фоне */
            padding: 4rem 1.5rem; margin-bottom: 2rem; border-radius: .3rem; text-align: center;
        }
        .page-header-section img.header-icon { width: 80px; height: 80px; margin-bottom: 1rem; } /* Без инверсии */

        .content-section { margin-bottom: 3rem; opacity: 0; transform: translateY(40px); }
        .content-section h3, .content-section h4 { 
            margin-bottom: 1.5rem; display: flex; align-items: center; 
            font-weight: 600; color: #343a40;
        }
        .content-section h3 img.section-icon, .content-section h4 img.section-icon { 
            width: 32px; height: 32px; margin-right: 0.8rem; opacity: 0.8;
        }

        /* KPI Рабочий лист */
        .kpi-worksheet-intro { margin-bottom: 2rem; }
        .kpi-area-card {
            background-color: #fff; border-radius: .5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem; overflow: hidden;
        }
        .kpi-area-header {
            background-color: var(--bs-primary-bg-subtle); color: var(--bs-primary-text-emphasis);
            padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .kpi-area-header h5 { margin-bottom: 0; font-size: 1.2rem; }
        .kpi-area-header .arrow-icon { transition: transform 0.3s ease; font-size: 1.5rem; }
        .kpi-area-card.active .kpi-area-header .arrow-icon { transform: rotate(180deg); }
        .kpi-area-content { padding: 1.5rem; display: block; height: 0; overflow: visible; } /* Скрыто, но для анимации GSAP */
        .kpi-table th { background-color: #f8f9fa; }

        /* PDCA Цикл */
        .pdca-cycle-container { display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; margin-top: 2rem; }
        .pdca-step {
            flex-basis: calc(25% - 2rem); min-width: 200px; margin: 1rem; padding: 1.5rem;
            background-color: #fff; border-radius: .5rem; box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-top: 5px solid transparent; /* Для цветовой индикации */
        }
        .pdca-step:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 6px 15px rgba(0,0,0,0.12); }
        .pdca-step img { width: 50px; height: 50px; margin-bottom: 1rem; }
        .pdca-step h5 { margin-bottom: 0.5rem; font-weight: 600; }
        .pdca-step p.details { font-size: 0.9rem; color: #555; display: none; margin-top: 0.75rem; text-align: left; }
        .pdca-step.active p.details { display: block; }
        /* Цвета для PDCA */
        .pdca-plan { border-top-color: var(--bs-info); }
        .pdca-do { border-top-color: var(--bs-success); }
        .pdca-check { border-top-color: var(--bs-warning); }
        .pdca-act { border-top-color: var(--bs-danger); }

        /* Интерактив KPI Мозговой штурм */
        #kpiBrainstormInteractive { background-color: #e9ecef; padding: 2rem; border-radius: .5rem; }
        .kpi-input-group { margin-bottom: 1.5rem; }
        #aiKpiFeedbackContainer { display: none; margin-top: 1.5rem; }
        #aiKpiFeedbackResult { white-space: pre-wrap; }
    </style>
</head>
<body>
    <header>
        <!-- ... (Шапка и полноэкранное меню, как в предыдущих файлах, активный пункт "5. Эффективность") ... -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow-sm">
            <div class="container">
                <a class="navbar-brand fw-bold d-flex align-items-center" href="../index.html">
                    <img src="../assets/images/logo.svg" alt="Лого НКО"> 
                    Семинар НКО
                </a>
                <button class="navbar-custom-toggler ms-auto" aria-label="Открыть меню" id="customMenuToggler" aria-expanded="false">
                    <svg viewBox="0 0 100 80" width="30" height="30" id="actualBurgerIcon" fill="currentColor">
                        <rect class="line line1" x="0" y="10" width="100" height="10" rx="5"></rect>
                        <rect class="line line2" x="0" y="35" width="100" height="10" rx="5"></rect>
                        <rect class="line line3" x="0" y="60" width="100" height="10" rx="5"></rect>
                    </svg>
                </button>
            </div>
        </nav>
    </header>

     <div class="fullscreen-menu" id="fullscreenMenu">
        <button class="close-menu-btn" id="closeFullscreenMenu" aria-label="Закрыть меню">×</button>
        <ul class="navbar-nav-fullscreen">
            <li class="nav-item fs-menu-item">
                <a class="nav-link" href="../index.html">Главная</a>
            </li>
            <li class="nav-item fs-menu-item custom-dropdown">
                <a class="nav-link dropdown-toggle-custom active" aria-current="page" href="#" id="sectionsDropdownCustomFs" role="button" aria-expanded="false">
                    Разделы
                </a>
                <ul class="dropdown-menu-custom">
                    <li><a class="dropdown-item" href="0_introduction.html">0. Введение</a></li>
                    <li><a class="dropdown-item" href="1_community_building.html">1. Сообщество</a></li>
                    <li><a class="dropdown-item" href="2_internal_communications.html">2. Коммуникации</a></li>
                    <li><a class="dropdown-item" href="3_infrastructure.html">3. Инфраструктура</a></li>
                    <li><a class="dropdown-item" href="4_legal_and_security.html">4. Безопасность</a></li>
                    <li><a class="dropdown-item active" href="5_effectiveness_and_development.html">5. Эффективность</a></li>
                    <li><a class="dropdown-item" href="6_crisis_management.html">6. Антикризис</a></li>
                    <li><a class="dropdown-item" href="7_cases_and_practice.html">7. Практика</a></li>
                </ul>
            </li>
            <li class="nav-item fs-menu-item">
                <a class="nav-link" href="useful_resources.html">Полезные ресурсы</a>
            </li>
        </ul>
    </div>

    <main>
        <div class="page-header-section">
            <img src="../assets/icons/efficiency.svg" alt="Эффективность и Развитие" class="header-icon">
            <h1 class="display-5 fw-bold">Раздел 5: Измерение Эффективности и Развитие</h1>
            <p class="lead">Как понять, что мы движемся в правильном направлении? Учимся ставить цели, измерять результаты и постоянно улучшаться.</p>
        </div>

        <div class="container py-4">
            <!-- 5.1-5.2. Рабочий лист "KPI для Моей НКО" -->
            <section class="content-section" id="s5-1">
                <h3>
                    <img src="../assets/icons/cases.svg" alt="KPI" class="section-icon">
                    5.1. Рабочий лист: "KPI для Моей НКО"
                </h3>
                <div class="kpi-worksheet-intro">
                    <p>Ключевые показатели эффективности (KPI) помогают отслеживать прогресс в достижении целей. Этот интерактивный лист поможет вам сформулировать KPI для различных областей вашей НКО. Кликните на область, чтобы развернуть и заполнить таблицу.</p>
                </div>

                <div id="kpiAreasContainer">
                    <!-- Карточки KPI будут добавлены JS -->
                </div>
            </section>

            <!-- 5.3. Схема "Цикл PDCA" -->
            <section class="content-section" id="s5-3">
                <h3>
                    <img src="../assets/icons/practical.svg" alt="PDCA" class="section-icon">
                    5.2. Цикл PDCA (Plan-Do-Check-Act) для НКО
                </h3>
                <p>Цикл PDCA (Планируй-Делай-Проверяй-Действуй), также известный как цикл Деминга-Шухарта, – это простой, но мощный инструмент для непрерывного улучшения процессов и проектов. Кликните на каждый этап, чтобы узнать больше.</p>
                <div class="pdca-cycle-container">
                    <div class="pdca-step pdca-plan">
                        <img src="../assets/icons/introngo.svg" alt="Планируй">
                        <h5>Plan (Планируй)</h5>
                        <p class="details"><strong>Описание:</strong> Определите проблему или возможность для улучшения. Поставьте четкие, измеримые цели. Разработайте план действий для достижения этих целей, включая необходимые ресурсы и сроки.<br><strong>Пример для НКО:</strong> Увеличить количество волонтеров на 20% за следующие 3 месяца. План: провести информационную кампанию, организовать день открытых дверей.</p>
                    </div>
                    <div class="pdca-step pdca-do">
                         <img src="../assets/icons/low_budget.svg" alt="Делай">
                        <h5>Do (Делай)</h5>
                        <p class="details"><strong>Описание:</strong> Реализуйте разработанный план. Важно собирать данные по ходу выполнения для последующего анализа.<br><strong>Пример для НКО:</strong> Запустить посты в соцсетях, разослать приглашения, провести день открытых дверей, регистрировать новых волонтеров.</p>
                    </div>
                    <div class="pdca-step pdca-check">
                         <img src="../assets/icons/efficiency.svg" alt="Проверяй">
                        <h5>Check (Проверяй)</h5>
                        <p class="details"><strong>Описание:</strong> Сравните полученные результаты с поставленными целями. Проанализируйте собранные данные. Что сработало? Что пошло не так? Какие были отклонения от плана?<br><strong>Пример для НКО:</strong> Через 3 месяца подсчитать количество новых волонтеров. Сравнить с целевым показателем. Проанализировать, какие каналы привлекли больше людей.</p>
                    </div>
                    <div class="pdca-step pdca-act">
                        <img src="../assets/icons/community.svg" alt="Действуй">
                        <h5>Act (Действуй/Корректируй)</h5>
                        <p class="details"><strong>Описание:</strong> На основе анализа примите меры. Если цели достигнуты, стандартизируйте успешные практики. Если нет – выявите причины и скорректируйте план для следующего цикла. Начните новый цикл PDCA.<br><strong>Пример для НКО:</strong> Если цель достигнута, закрепить успешные методы привлечения. Если нет – пересмотреть стратегию кампании, возможно, изменить каналы или сообщения и запустить новый цикл.</p>
                    </div>
                </div>
            </section>

             <!-- Интерактив: "Мозговой штурм KPI" -->
            <section class="content-section" id="kpiBrainstormInteractiveSection">
                <h3>
                    <img src="../assets/icons/interactivity.svg" alt="Мозговой штурм KPI" class="section-icon">
                    5.3. Интерактив: Мозговой штурм KPI
                </h3>
                <div id="kpiBrainstormInteractive" class="shadow-sm">
                    <p class="lead">Давайте вместе подумаем над KPI! Выберите одну из областей деятельности НКО и предложите 1-2 ключевых показателя эффективности (KPI), которые, по вашему мнению, важны для оценки успеха в этой области. Также кратко опишите, почему вы выбрали именно этот KPI.</p>
                    
                    <div class="kpi-input-group">
                        <label for="kpiAreaSelect" class="form-label fw-bold">Выберите Область НКО:</label>
                        <select class="form-select mb-2" id="kpiAreaSelect">
                            <option selected disabled value="">--- Выберите область ---</option>
                            <option value="Community Building">Community Building (Построение сообщества)</option>
                            <option value="Internal Communications">Внутренние коммуникации</option>
                            <option value="Infrastructure">Инфраструктура</option>
                            <option value="Security">Безопасность (цифровая, физическая)</option>
                            <option value="Advocacy">Программная/Адвокационная деятельность</option>
                        </select>
                        
                        <label for="kpiProposed" class="form-label fw-bold">Предложенный KPI (1-2 примера):</label>
                        <input type="text" class="form-control mb-2" id="kpiProposed" placeholder="Например, 'Уровень вовлеченности в соцсетях (ER)' или 'Количество волонтерских часов'">
                        
                        <label for="kpiRationale" class="form-label">Обоснование выбора KPI (почему он важен?):</label>
                        <textarea class="form-control" id="kpiRationale" rows="3" placeholder="Например, 'ER показывает, насколько контент интересен аудитории'"></textarea>
                    </div>
                    <button type="button" class="btn btn-warning text-dark" id="getKpiAiAdviceBtn">Отправить и получить комментарий ИИ</button>

                    <div id="aiKpiFeedbackContainer" class="mt-4">
                        <h5 class="text-primary">Комментарий от ИИ-помощника по KPI:</h5>
                        <div id="aiKpiFeedbackResult" class="p-3 border rounded bg-light-subtle text-muted">
                            <em>Выберите область, предложите KPI и нажмите кнопку...</em>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="py-4 bg-dark text-white-50 mt-5">
        <!-- ... (Подвал) ... -->
         <div class="container text-center">
             <small>Материалы семинара © 2024.</small> <br>
             <small><em>Информация на сайте носит ознакомительный характер и не является юридической консультацией. Для принятия решений всегда обращайтесь к квалифицированным специалистам.</em></small>
         </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        gsap.registerPlugin(ScrollTrigger); // EasePack не используется здесь, можно убрать если больше нигде не нужен

        // --- Код для полноэкранного меню (аналогично другим страницам) ---
        const customMenuToggler = document.getElementById('customMenuToggler');
        const fullscreenMenu = document.getElementById('fullscreenMenu');
        const closeFullscreenMenuBtn = document.getElementById('closeFullscreenMenu');
        if (customMenuToggler && fullscreenMenu) { /* ... весь код меню ... */ 
            const fsNav = fullscreenMenu.querySelector('.navbar-nav-fullscreen');
            const fsMenuItems = fsNav ? gsap.utils.toArray(fsNav.querySelectorAll('.fs-menu-item > a, .fs-menu-item > .dropdown-toggle-custom')) : [];
            const fsSubMenuItemsContainer = fsNav ? fsNav.querySelector('.fs-menu-item.custom-dropdown .dropdown-menu-custom') : null;
            const actualBurgerIcon = customMenuToggler.querySelector('svg');
            const burgerLine1 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line1') : null;
            const burgerLine2 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line2') : null;
            const burgerLine3 = actualBurgerIcon ? actualBurgerIcon.querySelector('.line3') : null;
            let burgerTimeline = gsap.timeline({ paused: true, reversed: true });
            if (burgerLine1 && burgerLine2 && burgerLine3) {
                const line1YInitial = parseFloat(burgerLine1.getAttribute('y'));
                const line2YInitial = parseFloat(burgerLine2.getAttribute('y'));
                const line3YInitial = parseFloat(burgerLine3.getAttribute('y'));
                if (!isNaN(line1YInitial) && !isNaN(line2YInitial) && !isNaN(line3YInitial)) {
                    burgerTimeline.to(burgerLine1,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross").to(burgerLine3,{duration:0.25,attr:{y:line2YInitial},ease:"power2.inOut"},"cross").to(burgerLine2,{duration:0.2,scaleX:0,transformOrigin:"50% 50%",ease:"power2.in"},"cross").to(burgerLine1,{duration:0.25,rotation:45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd").to(burgerLine3,{duration:0.25,rotation:-45,transformOrigin:"50% 50%",ease:"power2.out"},"crossEnd");
                } else { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
            } else if (actualBurgerIcon) { burgerTimeline.to(actualBurgerIcon, {rotation: 180, duration: 0.3, ease:"power2.inOut"}); }
            let fsMenuIsOpen = false;
            gsap.set(fullscreenMenu, { display: 'none', autoAlpha: 0 }); 
            if (fsMenuItems.length > 0) gsap.set(fsMenuItems, { autoAlpha: 0, y: 20 });
            if (fsSubMenuItemsContainer) gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
            const openFullscreenMenu = () => { if (fsMenuIsOpen) return; fsMenuIsOpen = true; fullscreenMenu.style.display = 'flex'; burgerTimeline.play(); customMenuToggler.classList.add('open'); customMenuToggler.setAttribute('aria-expanded', 'true'); const tlOpen = gsap.timeline(); tlOpen.to(fullscreenMenu, { autoAlpha: 1, duration: 0.35, ease: 'power1.out' }); if (fsMenuItems.length > 0) tlOpen.to(fsMenuItems, { autoAlpha: 1, y: 0, duration: 0.3, stagger: 0.06, ease: 'power1.out' }, "-=0.2"); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if (sectionsDropdownCustomFs && sectionsDropdownCustomFs.classList.contains('active') && fsSubMenuItemsContainer) { if (sectionsDropdownCustomFs.getAttribute('aria-expanded') === 'true' || fsSubMenuItemsContainer.style.height === 'auto') { tlOpen.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration: 0.2, stagger: 0.04, ease: 'power1.out' }, "-=0.1"); }}};
            const closeFullscreenMenu = () => { if (!fsMenuIsOpen) return; fsMenuIsOpen = false; burgerTimeline.reverse(); customMenuToggler.classList.remove('open'); customMenuToggler.setAttribute('aria-expanded', 'false'); const tlClose = gsap.timeline({onComplete: () => { fullscreenMenu.style.display = 'none'; if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10}); gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0}); const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs'); if(sectionsDropdownCustomFs) sectionsDropdownCustomFs.setAttribute('aria-expanded', 'false');}}}); if (fsSubMenuItemsContainer && (fsSubMenuItemsContainer.style.height !== '0px' && fsSubMenuItemsContainer.style.height !== '' && fsSubMenuItemsContainer.style.height !== null)) { tlClose.to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.15, stagger: {each:0.03, from:"end"}, ease:'power1.in' });} if (fsMenuItems.length > 0) tlClose.to(fsMenuItems, { autoAlpha: 0, y: 15, duration: 0.2, stagger: { each: 0.04, from: "end" }, ease: 'power1.in' }, fsSubMenuItemsContainer ? "-=0.1" : 0); tlClose.to(fullscreenMenu, { autoAlpha: 0, duration: 0.25, ease: 'power1.in' }, fsMenuItems.length > 0 ? "-=0.1" : 0); };
            customMenuToggler.addEventListener('click', () => { fsMenuIsOpen ? closeFullscreenMenu() : openFullscreenMenu(); });
            if (closeFullscreenMenuBtn) closeFullscreenMenuBtn.addEventListener('click', closeFullscreenMenu);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && fsMenuIsOpen) closeFullscreenMenu(); });
            const sectionsDropdownCustomFs = document.getElementById('sectionsDropdownCustomFs');
            if (sectionsDropdownCustomFs && fsSubMenuItemsContainer) {
                gsap.set(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop:0, marginBottom:0 }); gsap.set(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), {autoAlpha:0, y:10});
                let subMenuFsIsOpen = false;
                sectionsDropdownCustomFs.addEventListener('click', (e) => {
                    e.preventDefault(); subMenuFsIsOpen = !subMenuFsIsOpen; sectionsDropdownCustomFs.setAttribute('aria-expanded', subMenuFsIsOpen.toString());
                    if (subMenuFsIsOpen) { gsap.timeline().to(fsSubMenuItemsContainer, { height: 'auto', autoAlpha: 1, marginTop: '0.5rem', marginBottom: '0.5rem', duration: 0.3, ease: 'power1.out' }).to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:1, y:0, duration:0.25, stagger:0.05, ease:'power1.out' }, "-=0.2");
                    } else { gsap.timeline().to(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item'), { autoAlpha:0, y:10, duration:0.2, stagger:{each:0.04, from:"end"}, ease:'power1.in' }).to(fsSubMenuItemsContainer, { height: 0, autoAlpha: 0, marginTop: 0, marginBottom: 0, duration: 0.3, ease: 'power1.in' }, "-=0.1");}
                });
                const fsSubMenuLinks = fsSubMenuItemsContainer ? gsap.utils.toArray(fsSubMenuItemsContainer.querySelectorAll('a.dropdown-item')) : [];
                fsSubMenuLinks.forEach(link => { link.addEventListener('mouseenter', () => gsap.to(link, { color: '#0d6efd', x: 3, duration: 0.2 })); link.addEventListener('mouseleave', () => gsap.to(link, { color: (link.classList.contains('active') ? '#0d6efd' : '#495057'), x: 0, duration: 0.2 }));});
            }
            const activeFsDropdownItem = fullscreenMenu.querySelector('.dropdown-menu-custom a.dropdown-item.active');
            if (activeFsDropdownItem) { activeFsDropdownItem.style.color = '#0d6efd'; activeFsDropdownItem.style.fontWeight = '500';}
        }


        // --- ОБЩИЕ АНИМАЦИИ СТРАНИЦЫ ---
        gsap.from(".page-header-section h1", {duration: 0.8, y: -50, opacity: 0, ease: "power2.out", delay: 0.2});
        gsap.from(".page-header-section p.lead", {duration: 0.8, y: -30, opacity: 0, ease: "power2.out", delay: 0.4});
        gsap.from(".page-header-section .header-icon", {duration: 1, scale: 0.5, opacity: 0, ease: "back.out(1.7)", delay: 0.1});

        const contentSections = gsap.utils.toArray('.content-section');
        contentSections.forEach(section => {
            gsap.to(section, { 
                opacity: 1, y: 0, duration: 0.7, ease: "power1.out",
                scrollTrigger: { trigger: section, start: "top 85%", once: true }
            });
        });

        // --- Рабочий лист KPI ---
        const kpiAreasData = [
            { title: "Построение Сообщества (Community Building)", icon: "community.svg", examples: [
                { goal: "Увеличить онлайн-аудиторию", kpi: "Прирост подписчиков в соцсетях; Охват постов", measure: "Статистика соцсетей" },
                { goal: "Повысить вовлеченность", kpi: "Уровень вовлеченности (ER); Количество комментариев/репостов", measure: "Аналитика постов; Ручной подсчет" },
                { goal: "Привлечь волонтеров", kpi: "Количество новых волонтеров; Количество волонтерских часов", measure: "Анкеты волонтеров; Учет времени" }
            ]},
            { title: "Внутренние Коммуникации", icon: "communication.svg", examples: [
                { goal: "Улучшить информированность команды", kpi: "Уровень удовлетворенности коммуникацией (опрос); Скорость распространения важной информации", measure: "Анонимные опросы; Замеры времени" },
                { goal: "Повысить эффективность встреч", kpi: "Процент выполненных решений по итогам встреч; Оценка встреч участниками", measure: "Протоколы; Опросники" }
            ]},
            { title: "Инфраструктура", icon: "Infrastructure.svg", examples: [
                { goal: "Обеспечить бесперебойную работу сайта", kpi: "Время доступности сайта (uptime); Скорость загрузки страниц", measure: "Сервисы мониторинга (UptimeRobot); Google PageSpeed" },
                { goal: "Оптимизировать использование CRM", kpi: "Полнота заполнения данных в CRM; Количество сотрудников, регулярно использующих CRM", measure: "Выборочная проверка; Статистика CRM" }
            ]},
             { title: "Безопасность", icon: "safety.svg", examples: [
                { goal: "Повысить уровень цифровой грамотности команды", kpi: "Процент сотрудников, прошедших тренинг по кибербезопасности; Количество инцидентов (фишинг)", measure: "Учет тренингов; Журнал инцидентов" },
                { goal: "Обеспечить безопасность данных", kpi: "Процент устройств с шифрованием; Регулярность бэкапов", measure: "Технический аудит; Проверка логов бэкапов" }
            ]},
             { title: "Программная/Адвокационная Деятельность", icon: "rights.svg", examples: [
                { goal: "Увеличить количество оказанной помощи", kpi: "Число успешных кейсов/консультаций; Количество бенефициаров", measure: "Внутренняя статистика; Отчеты по проектам" },
                { goal: "Повысить осведомленность о проблеме", kpi: "Количество публикаций в СМИ о проблеме/деятельности НКО; Охват информационных кампаний", measure: "Медиамониторинг; Статистика соцсетей/сайта" }
            ]}
        ];

        const kpiContainer = document.getElementById('kpiAreasContainer');
        kpiAreasData.forEach((area, areaIdx) => {
            const card = document.createElement('div');
            card.className = 'kpi-area-card';

            let examplesHtml = '<div class="table-responsive"><table class="table kpi-table table-sm table-hover"><thead><tr><th>Ключевая цель</th><th>Возможные KPI (примеры)</th><th>Как измерить?</th></tr></thead><tbody>';
            area.examples.forEach((ex, exIdx) => {
                examplesHtml += `<tr data-row="${exIdx}">
                    <td class="kpi-quiz-cell kpi-goal" data-col="goal" data-row="${exIdx}">${ex.goal}</td>
                    <td class="kpi-quiz-cell kpi-kpi" data-col="kpi" data-row="${exIdx}">${ex.kpi}</td>
                    <td class="kpi-quiz-cell kpi-measure" data-col="measure" data-row="${exIdx}">${ex.measure}</td>
                </tr>`;
            });
            examplesHtml += '</tbody></table></div>';

            card.innerHTML = `
                <div class="kpi-area-header">
                    <h5><img src="../assets/icons/${area.icon}" alt="${area.title}" style="width:28px; height:28px;" class="me-2">${area.title}</h5> 
                    <span class="arrow-icon">▼</span>
                </div>
                <div class="kpi-area-content">
                    ${examplesHtml}
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" style="display:none;" disabled>Отправить выбранное ИИ для оценки</button>
                        <div class="kpi-ai-feedback mt-3" style="display:none;">
                            <h6 class="text-primary">Комментарий от ИИ-помощника по KPI:</h6>
                            <div class="kpi-ai-feedback-result p-2 border rounded bg-light-subtle text-muted"><em>Сделайте выбор по каждому столбцу и отправьте на оценку...</em></div>
                        </div>
                    </div>
                </div>
            `;
            kpiContainer.appendChild(card);

            const header = card.querySelector('.kpi-area-header');
            const content = card.querySelector('.kpi-area-content');
            gsap.set(content, { height: 0, autoAlpha: 0 });

            header.addEventListener('click', () => {
                const isActive = card.classList.toggle('active');
                if (isActive) {
                    gsap.set(content, {height: 'auto', autoAlpha: 1});
                    gsap.from(content, {height: 0, autoAlpha: 0, duration: 0.4, ease: 'power2.inOut', onComplete: () => {
                        content.style.height = 'auto';
                        // Плавная прокрутка к карточке, чтобы кнопка и ответ были видны
                        card.scrollIntoView({behavior: 'smooth', block: 'start'});
                    }});
                } else {
                    gsap.to(content, {height: 0, autoAlpha: 0, duration: 0.4, ease: 'power2.inOut'});
                }
            });

            // --- Квиз-логика выбора по столбцам ---
            const quizCells = card.querySelectorAll('.kpi-quiz-cell');
            const sendBtn = card.querySelector('button.btn-success');
            const feedbackBlock = card.querySelector('.kpi-ai-feedback');
            const feedbackResult = card.querySelector('.kpi-ai-feedback-result');
            let selected = { goal: null, kpi: null, measure: null };

            quizCells.forEach(cell => {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', () => {
                    const col = cell.getAttribute('data-col');
                    // Снять выделение с других ячеек этого столбца
                    card.querySelectorAll(`.kpi-quiz-cell.kpi-${col}`).forEach(c => c.classList.remove('table-success'));
                    // Выделить выбранную
                    cell.classList.add('table-success');
                    selected[col] = cell.innerText;
                    // Проверить, выбраны ли все три
                    if (selected.goal && selected.kpi && selected.measure) {
                        sendBtn.style.display = 'inline-block';
                        sendBtn.disabled = false;
                    } else {
                        sendBtn.style.display = 'none';
                        sendBtn.disabled = true;
                    }
                    feedbackBlock.style.display = 'none';
                });
            });

            sendBtn.addEventListener('click', async () => {
                if (!selected.goal || !selected.kpi || !selected.measure) return;
                sendBtn.disabled = true;
                sendBtn.innerText = 'Отправка...';
                feedbackBlock.style.display = 'block';
                feedbackResult.innerHTML = '<em>📊 ИИ оценивает ваш выбор...</em>';
                try {
                    const userPrompt = `Пользователь выбрал:\nЦель: ${selected.goal}\nKPI: ${selected.kpi}\nМетрика: ${selected.measure}\nПрокомментируй этот выбор. Является ли KPI SMART (конкретным, измеримым, достижимым, релевантным, ограниченным по времени)? Что можно улучшить? Ответ на русском.`;
                    const response = await fetch('http://127.0.0.1:3355/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "qwen3-1.7b",
                            messages: [
                                { role: "system", content: "Ты — ИИ-ментор по стратегическому развитию НКО. Твоя задача — дать конструктивный фидбэк на выбранные KPI, оценив их по SMART-критериям. Будь краток, дружелюбен и предлагай улучшения. Ответ на русском." },
                                { role: "user", content: userPrompt }
                            ],
                            temperature: 0.5, max_tokens: 400, stream: false
                        })
                    });
                    if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
                    const data = await response.json();
                    let aiMessage = data.choices?.[0]?.message?.content?.trim() || "Не удалось получить комментарий от ИИ.";
                    aiMessage = aiMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
                    if (aiMessage.includes('<li>')) { aiMessage = aiMessage.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); aiMessage = aiMessage.replace(/<\/ul>\s*<ul>/g, '');}
                    aiMessage = aiMessage.replace(/\n/g, '<br>');
                    feedbackResult.innerHTML = aiMessage;
                } catch (error) {
                    feedbackResult.innerHTML = `😥 Ошибка получения совета от ИИ. <small>${error.message}</small>`;
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.innerText = 'Отправить выбранное ИИ для оценки';
                }
            });
        });
        
        // --- PDCA Цикл Интерактив (ИСПРАВЛЕННЫЙ) ---
        const pdcaSteps = document.querySelectorAll('.pdca-step');
        pdcaSteps.forEach(step => {
            const details = step.querySelector('p.details');
            gsap.set(details, {height: 0, autoAlpha: 0, marginTop:0});

            step.addEventListener('click', () => {
                const isActive = step.classList.toggle('active');
                // Анимация только для текущего элемента
                if (isActive) {
                    gsap.set(details, {height: 'auto', autoAlpha: 1, marginTop: '0.75rem'});
                    gsap.from(details, {height: 0, autoAlpha: 0, marginTop:0, duration: 0.3, ease: 'power1.inOut'});
                } else {
                    gsap.to(details, {height: 0, autoAlpha: 0, marginTop:0, duration: 0.3, ease: 'power1.inOut'});
                }
            });
        });

        // --- Мозговой штурм KPI с ИИ ---
        const getKpiAiAdviceBtn = document.getElementById('getKpiAiAdviceBtn');
        const aiKpiFeedbackContainer = document.getElementById('aiKpiFeedbackContainer');
        const aiKpiFeedbackResultEl = document.getElementById('aiKpiFeedbackResult');

        if(getKpiAiAdviceBtn && aiKpiFeedbackContainer && aiKpiFeedbackResultEl) {
            gsap.set(aiKpiFeedbackContainer, {display: 'none', autoAlpha:0});
            getKpiAiAdviceBtn.addEventListener('click', async () => {
                const area = document.getElementById('kpiAreaSelect').value;
                const kpi = document.getElementById('kpiProposed').value;
                const rationale = document.getElementById('kpiRationale').value;

                if (!area || !kpi || !rationale) {
                    alert("Пожалуйста, выберите область, предложите KPI и его обоснование.");
                    return;
                }
                 gsap.timeline().set(aiKpiFeedbackContainer, {display: 'block'}).to(aiKpiFeedbackContainer, {autoAlpha:1, y:0, duration:0.4, ease: 'power2.out'});
                aiKpiFeedbackResultEl.innerHTML = '<em>📊 ИИ оценивает ваши KPI...</em>';
                gsap.fromTo(aiKpiFeedbackResultEl, {opacity:0.5, y:5}, {opacity:1, y:0, duration:0.3});
                
                try {
                    const userPrompt = `
Пользователь НКО предлагает KPI для области "${area}":
Предложенный KPI: ${kpi}
Обоснование: ${rationale}

Прокомментируй это предложение. Является ли KPI SMART (конкретным, измеримым, достижимым, релевантным, ограниченным по времени - насколько это возможно оценить)? Что можно улучшить? Ответ на русском. Кратко.
                    `;
                     const response = await fetch('https://beb0-2a02-8388-8b00-5580-4a08-9764-1212-46e7.ngrok-free.app/v1/chat/completions', { /* ... */ 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "qwen3-1.7b",
                            messages: [
                                { role: "system", content: "Ты — ИИ-ментор по стратегическому развитию НКО. Твоя задача — дать конструктивный и краткий фидбэк на предложенные KPI, оценив их по SMART-критериям (где это возможно). Кратко. Ответ на русском." },
                                { role: "user", content: userPrompt }
                            ],
                            temperature: 0.5, max_tokens: 400, stream: false
                        })
                    });
                    if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
                    const data = await response.json();
                    let aiMessage = data.choices?.[0]?.message?.content?.trim() || "Не удалось получить комментарий от ИИ.";
                    
                    aiMessage = aiMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/^\s*-\s*(.*)/gm, '<li>$1</li>');
                    if (aiMessage.includes('<li>')) { aiMessage = aiMessage.replace(/(<li>.*?<\/li>\s*)+/g, (match) => `<ul>${match}</ul>`); aiMessage = aiMessage.replace(/<\/ul>\s*<ul>/g, '');}
                    aiMessage = aiMessage.replace(/\n/g, '<br>');

                    gsap.to(aiKpiFeedbackResultEl, {opacity:0, y:-5, duration:0.2, onComplete: () => {
                        aiKpiFeedbackResultEl.innerHTML = aiMessage;
                        gsap.to(aiKpiFeedbackResultEl, {opacity:1, y:0, duration:0.4, ease: 'power2.out'});
                    }});
                } catch (error) { /* ... */ 
                     console.error('AI KPI Advice Error:', error);
                    gsap.to(aiKpiFeedbackResultEl, {opacity:0, y:-5, duration:0.2, onComplete: () => {
                        aiKpiFeedbackResultEl.innerHTML = `😥 Ошибка получения совета от ИИ. <small>${error.message}</small>`;
                        gsap.to(aiKpiFeedbackResultEl, {opacity:1, y:0, duration:0.4, ease: 'power2.out'});
                    }});
                }
            });
        }
        
        // --- PDF экспорт раздела 5 ---
        const exportBtn = document.getElementById('exportSectionResultsBtn');
        if (!exportBtn) {
            // Добавить кнопку в футер, если её нет
            const footer = document.querySelector('footer .container.text-center .mt-4') || document.querySelector('footer .container.text-center');
            if (footer) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-success';
                btn.id = 'exportSectionResultsBtn';
                btn.textContent = 'Выгрузить результаты раздела';
                footer.appendChild(btn);
            }
        }
        const exportBtn5 = document.getElementById('exportSectionResultsBtn');
        if (exportBtn5) {
            exportBtn5.addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({unit: 'pt', format: 'a4'});
                if (window.QanelasRegularFontData && window.QanelasRegularFontData.base64) {
                    doc.addFileToVFS('Qanelas-Regular.ttf', window.QanelasRegularFontData.base64);
                    doc.addFont('Qanelas-Regular.ttf', 'Qanelas', 'normal');
                }
                doc.setFont('Qanelas', 'normal');
                const pageWidth = doc.internal.pageSize.getWidth();
                let y = 40;
                // Заголовок
                doc.setFontSize(22);
                doc.setTextColor('#fd7e14');
                doc.text('Раздел 5: Эффективность и развитие', pageWidth/2, y, {align:'center'});
                y += 30;
                doc.setFontSize(14);
                doc.setTextColor('#333');
                // Секции
                document.querySelectorAll('.content-section').forEach(section => {
                    const title = section.querySelector('h3, .section-title')?.innerText || '';
                    if (title) {
                        doc.setFontSize(15);
                        doc.setTextColor('#fd7e14');
                        doc.text(title, 40, y);
                        y += 18;
                    }
                    doc.setFontSize(11);
                    doc.setTextColor('#444');
                    section.querySelectorAll('p, ul, ol').forEach(el => {
                        let text = '';
                        if (el.tagName === 'P') text = el.innerText;
                        if (el.tagName === 'UL' || el.tagName === 'OL') {
                            text = Array.from(el.children).map(li => '- ' + li.innerText).join('\n');
                        }
                        if (text) {
                            const split = doc.splitTextToSize(text, pageWidth-80);
                            doc.text(split, 40, y);
                            y += split.length * 15 + 5;
                        }
                    });
                    y += 10;
                });
                // AI feedback по KPI (если есть)
                const aiKpiFeedback = document.getElementById('aiKpiFeedbackResult')?.innerText;
                if (aiKpiFeedback && aiKpiFeedback.trim() && aiKpiFeedback.trim() !== '📊 ИИ оценивает ваши KPI...') {
                    doc.setFontSize(14);
                    doc.setTextColor('#fd7e14');
                    doc.text('AI-отзыв по вашим KPI:', 40, y);
                    y += 18;
                    doc.setFontSize(11);
                    doc.setTextColor('#444');
                    const split = doc.splitTextToSize(aiKpiFeedback, pageWidth-80);
                    doc.text(split, 40, y);
                    y += split.length * 15 + 10;
                }
                doc.save('effectiveness_and_development_results.pdf');
            });
        }

        ScrollTrigger.refresh();
    });
    </script>
</body>
</html>